<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA DE COMANDO - 1¬∫ BBM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: { 
                extend: { 
                    colors: { 'fire-red': '#b71c1c', 'fire-yellow': '#FFD700', 'dark-bg': '#0f172a' } 
                } 
            }
        }
    </script>
    
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', sans-serif; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(12px); border-radius: 0.5rem; }
        
        /* LINHAS DO CALEND√ÅRIO */
        .calendar-row { display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px; margin-bottom: 12px; }
        .calendar-row-large { display: grid; grid-template-columns: repeat(9, 1fr); gap: 8px; margin-bottom: 12px; } /* Para linha de 9 dias */
        
        /* CARD DO DIA */
        .day-card { background: rgba(15, 23, 42, 0.9); border: 1px solid #334155; min-height: 160px; display: flex; flex-direction: column; }
        .day-header { background: #1e293b; color: #FFD700; font-weight: bold; text-align: center; font-size: 11px; padding: 2px; border-bottom: 1px solid #334155; }
        
        /* INPUTS */
        .role-group { padding: 4px; flex-grow: 1; display: flex; flex-col; justify-content: space-evenly; }
        .role-row { margin-bottom: 3px; }
        .role-label { font-size: 8px; color: #64748b; font-weight: bold; uppercase; margin-bottom: 1px; }
        select { background: #0f172a; border: 1px solid #475569; color: white; width: 100%; font-size: 10px; height: 22px; border-radius: 3px; }
        select:focus { border-color: #FFD700; outline: none; }
        
        /* RESPONSIVIDADE PARA TELAS PEQUENAS */
        @media (max-width: 1200px) {
            .calendar-row, .calendar-row-large { grid-template-columns: repeat(4, 1fr); }
        }
        @media (max-width: 768px) {
            .calendar-row, .calendar-row-large { grid-template-columns: repeat(2, 1fr); }
        }

        /* PRINT STYLES */
        @media print {
            @page { size: landscape; margin: 5mm; }
            body { background: white; color: black; }
            .no-print, header, .editor-view, #painel-status { display: none !important; }
            #view-print { display: block !important; }
            table { width: 100%; border-collapse: collapse; font-size: 7pt; }
            th, td { border: 1px solid black; padding: 2px; text-align: center; }
            .cell-24 { background: #ddd !important; -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-slate-900 border-b border-white/10 p-3 sticky top-0 z-50 shadow-lg no-print">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img src="https://upload.wikimedia.org/wikipedia/commons/6/6f/Brasao_do_Rio_Grande_do_Sul.svg" class="h-8">
                <div>
                    <h1 class="font-black text-white text-base leading-none">ESCALA 1¬∫ BBM</h1>
                    <h2 class="text-[10px] text-fire-yellow font-bold tracking-widest">SISTEMA INTELIGENTE</h2>
                </div>
            </div>
            <div class="flex gap-2 bg-slate-800 p-1.5 rounded-lg">
                <select id="sel-pelotao" class="bg-slate-700 border-slate-600 text-white font-bold rounded w-40 text-xs" onchange="resetarPlanner()">
                    <option value="">SELECIONE PELOT√ÉO...</option>
                </select>
                <button onclick="alternarVisao('editor')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-blue-500"><i class="fas fa-edit"></i> EDITOR</button>
                <button onclick="alternarVisao('print')" class="bg-slate-600 text-gray-300 px-3 py-1 rounded text-xs font-bold hover:bg-slate-500"><i class="fas fa-table"></i> IMPRESS√ÉO</button>
                <button onclick="salvarEscala()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-1 rounded text-xs font-bold shadow-lg"><i class="fas fa-save"></i> SALVAR</button>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-2 flex-grow w-full max-w-[98%]">

        <div id="painel-status" class="mb-4 hidden grid grid-cols-4 gap-2 no-print">
            <div class="glass-panel p-2 border-l-4 border-blue-500 text-center"><p class="text-[10px] text-gray-400">EFETIVO APTO</p><p class="text-lg font-bold" id="stat-total">0</p></div>
            <div class="glass-panel p-2 border-l-4 border-green-500 text-center"><p class="text-[10px] text-gray-400">DIAS ESCALADOS</p><p class="text-lg font-bold" id="stat-dias">0/31</p></div>
            <div class="glass-panel p-2 border-l-4 border-yellow-500 text-center"><p class="text-[10px] text-gray-400">PREVIS√ÉO ETAPAS</p><p class="text-lg font-bold" id="stat-etapas">0</p></div>
            <div class="glass-panel p-2 border-l-4 border-red-500 text-center"><p class="text-[10px] text-gray-400">CUSTO HE (R$)</p><p class="text-lg font-bold" id="stat-gse">R$ 0,00</p></div>
        </div>

        <div id="view-editor" class="editor-view hidden">
            
            <div class="text-xs text-gray-500 mb-1 font-bold ml-1">SEMANA 1 (01-08)</div>
            <div id="linha-1" class="calendar-row"></div>
            
            <div class="text-xs text-gray-500 mb-1 font-bold ml-1 mt-3">SEMANA 2 (09-16)</div>
            <div id="linha-2" class="calendar-row"></div>

            <div class="text-xs text-gray-500 mb-1 font-bold ml-1 mt-3">SEMANA 3 (17-25)</div>
            <div id="linha-3" class="calendar-row-large"></div>

            <div class="text-xs text-gray-500 mb-1 font-bold ml-1 mt-3">SEMANA 4 (26-FINAL)</div>
            <div id="linha-4" class="calendar-row"></div>

            <div id="msg-inicial" class="text-center py-20 text-gray-500">
                <i class="fas fa-arrow-up text-3xl mb-4 animate-bounce"></i><br>
                Selecione o Pelot√£o acima para carregar o calend√°rio.
            </div>
        </div>

        <div id="view-print" class="hidden bg-white text-black p-2 rounded">
            <div class="text-center mb-2 border-b pb-2">
                <h3 class="font-bold text-xs">ESTADO DO RIO GRANDE DO SUL - CBM RS - 1¬∫ BBM</h3>
                <p id="titulo-impresso" class="text-sm font-bold uppercase">ESCALA JANEIRO 2026</p>
            </div>
            <table class="w-full text-[10px]">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="text-left pl-2 w-48">NOME</th>
                        <script>for(let i=1;i<=31;i++) document.write(`<th>${i}</th>`)</script>
                    </tr>
                </thead>
                <tbody id="tabela-print-body"></tbody>
            </table>
            <div class="assinaturas flex justify-around mt-10 text-xs">
                <div class="border-t border-black w-1/3 text-center pt-1">Sargenteante</div>
                <div class="border-t border-black w-1/3 text-center pt-1">Comandante</div>
            </div>
        </div>

    </main>

    <div id="modal-fin" class="fixed inset-0 bg-black/90 z-[60] hidden flex items-center justify-center p-4 no-print">
        <div class="bg-slate-800 w-full max-w-2xl rounded-lg border border-white/10 flex flex-col max-h-[90vh]">
            <div class="p-4 bg-slate-900 text-white font-bold flex justify-between">
                <span>RESUMO SALVO</span>
                <button onclick="document.getElementById('modal-fin').classList.add('hidden')"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 overflow-auto" id="conteudo-fin"></div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzwCdGHXkNF5IBhbLgAw8IlnZPrRLwEQ46uHgerfdpLsZnKhw2-KB26J4X-16VrzjGR/exec"; // <--- COLE SUA URL

        let efetivoGlobal = [];
        let escalaTemp = {}; 
        let contagemServicos = {}; // Para ordenar por "mais folgado"

        async function init() {
            try {
                const res = await fetch(`${API_URL}?action=getEfetivo`);
                efetivoGlobal = await res.json();
                
                // Popula Pelot√µes (√önicos)
                const pelotoes = [...new Set(efetivoGlobal.map(m => m.pelotao))].sort();
                const sel = document.getElementById('sel-pelotao');
                pelotoes.forEach(p => {
                    if(p !== "GERAL" && p !== "ERRO") {
                        const opt = document.createElement('option');
                        opt.value = p; opt.innerText = p;
                        sel.appendChild(opt);
                    }
                });
            } catch (e) { alert("Erro ao carregar: " + e); }
        }

        function resetarPlanner() {
            const pelotao = document.getElementById('sel-pelotao').value;
            if(!pelotao) {
                document.getElementById('msg-inicial').classList.remove('hidden');
                ['1','2','3','4'].forEach(n => document.getElementById(`linha-${n}`).innerHTML = "");
                document.getElementById('painel-status').classList.add('hidden');
                return;
            }

            document.getElementById('msg-inicial').classList.add('hidden');
            document.getElementById('painel-status').classList.remove('hidden');
            document.getElementById('view-editor').classList.remove('hidden');
            alternarVisao('editor');

            // Zera contadores
            efetivoGlobal.forEach(m => contagemServicos[m.nome] = 0);
            document.getElementById('stat-total').innerText = efetivoGlobal.filter(m => m.pelotao === pelotao).length;

            // Gera Calend√°rio nas 4 linhas
            gerarLinha(1, 8, 'linha-1', pelotao);
            gerarLinha(9, 16, 'linha-2', pelotao);
            gerarLinha(17, 25, 'linha-3', pelotao);
            gerarLinha(26, 31, 'linha-4', pelotao);
        }

        function gerarLinha(inicio, fim, idDiv, pelotao) {
            let html = "";
            for(let i=inicio; i<=fim; i++) {
                html += `
                <div class="day-card rounded overflow-hidden">
                    <div class="day-header">DIA ${i}</div>
                    <div class="role-group">
                        <div class="role-row">
                            <div class="role-label">CG (CMT GU)</div>
                            <select id="d${i}-CG" onchange="atualizar(${i}, 'CG', this.value)">
                                <option value="">- VAGO -</option>
                                ${gerarOpcoes(pelotao, i, 'CG')}
                            </select>
                        </div>
                        <div class="role-row">
                            <div class="role-label text-blue-300">MOTORISTA (COV)</div>
                            <select id="d${i}-COV" onchange="atualizar(${i}, 'COV', this.value)">
                                <option value="">- VAGO -</option>
                                ${gerarOpcoes(pelotao, i, 'COV')}
                            </select>
                        </div>
                        <div class="role-row">
                            <div class="role-label">COMBATENTE 1</div>
                            <select id="d${i}-CB1" onchange="atualizar(${i}, 'CB1', this.value)">
                                <option value="">- VAGO -</option>
                                ${gerarOpcoes(pelotao, i, 'CB')}
                            </select>
                        </div>
                        <div class="role-row">
                            <div class="role-label">COMBATENTE 2</div>
                            <select id="d${i}-CB2" onchange="atualizar(${i}, 'CB2', this.value)">
                                <option value="">- VAGO -</option>
                                ${gerarOpcoes(pelotao, i, 'CB')}
                            </select>
                        </div>
                    </div>
                </div>`;
            }
            document.getElementById(idDiv).innerHTML = html;
        }

        // --- INTELIG√äNCIA DE FILTRO E ORDENA√á√ÉO ---
        function gerarOpcoes(pelotao, dia, funcaoVaga) {
            // 1. Filtra pelo Pelot√£o
            let lista = efetivoGlobal.filter(m => m.pelotao === pelotao);

            // 2. Filtra pela Fun√ß√£o (Coluna I)
            if (funcaoVaga === 'COV') {
                // S√≥ mostra quem √© COV de fato
                lista = lista.filter(m => m.funcao.includes('COV'));
            } else {
                // CG e CB podem ser qualquer um, MENOS quem √© Oficial/Auxiliar (J√° filtrado no backend)
                // Se quiser que COV n√£o seja escalado como Combatente, descomente abaixo:
                // lista = lista.filter(m => !m.funcao.includes('COV')); 
            }

            // 3. Regra de Descanso (Quem trabalhou ontem some)
            let escalaOntem = escalaTemp[dia-1] || {};
            let nomesOntem = Object.values(escalaOntem);
            lista = lista.filter(m => !nomesOntem.includes(m.nome));

            // 4. Regra "Mais Folgado" (Ordena√ß√£o)
            // Quem tem menos servi√ßos (contagemServicos) aparece primeiro
            lista.sort((a, b) => {
                let countA = contagemServicos[a.nome] || 0;
                let countB = contagemServicos[b.nome] || 0;
                return countA - countB;
            });

            // Gera HTML com bolinhas coloridas
            return lista.map(m => {
                let count = contagemServicos[m.nome] || 0;
                let cor = count < 6 ? 'üü¢' : (count > 9 ? 'üî¥' : 'üü°');
                return `<option value="${m.nome}">${cor} ${m.posto} ${m.nome} (${count})</option>`;
            }).join('');
        }

        function atualizar(dia, cargo, nome) {
            // Remove contagem anterior se tinha algu√©m
            if(escalaTemp[dia] && escalaTemp[dia][cargo]) {
                let antigo = escalaTemp[dia][cargo];
                if(contagemServicos[antigo] > 0) contagemServicos[antigo]--;
            }

            if(!escalaTemp[dia]) escalaTemp[dia] = {};
            
            if(nome === "") {
                delete escalaTemp[dia][cargo];
            } else {
                escalaTemp[dia][cargo] = nome;
                // Adiciona contagem
                if(!contagemServicos[nome]) contagemServicos[nome] = 0;
                contagemServicos[nome]++;
            }

            // Atualiza contadores visuais
            document.getElementById('stat-dias').innerText = Object.keys(escalaTemp).length + "/31";
            
            // Recarrega APENAS o dia seguinte para aplicar descanso (evita recarregar tudo)
            if(dia < 31) refreshDia(dia + 1);
        }

        function refreshDia(dia) {
            const pelotao = document.getElementById('sel-pelotao').value;
            if(!pelotao) return;
            
            ['CG','COV','CB1','CB2'].forEach(role => {
                const el = document.getElementById(`d${dia}-${role}`);
                if(el) {
                    const val = el.value;
                    // Determina tipo de vaga para filtro correto
                    let tipoVaga = role === 'COV' ? 'COV' : 'CB';
                    el.innerHTML = `<option value="">- VAGO -</option>` + gerarOpcoes(pelotao, dia, tipoVaga);
                    el.value = val;
                }
            });
        }

        // --- SALVAR ---
        async function salvarEscala() {
            const btn = document.querySelector('button[onclick="salvarEscala()"]');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ...';
            
            let payload = [];
            for(let d=1; d<=31; d++) {
                if(escalaTemp[d]) {
                    Object.values(escalaTemp[d]).forEach(nome => {
                        payload.push({ nome: nome, dia: d, codigo: "24" });
                    });
                }
            }

            try {
                await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                const res = await fetch(API_URL);
                const dados = await res.json();
                
                // Mostra Financeiro
                const div = document.getElementById('conteudo-fin');
                div.innerHTML = `
                <div class="grid grid-cols-2 gap-4 mb-4 text-center">
                    <div class="bg-slate-700 p-2 rounded"><span class="text-xs text-gray-400">TOTAL HE</span><br><span class="text-xl font-bold text-green-400">${dados.financeiro.totais.valorGSE}</span></div>
                    <div class="bg-slate-700 p-2 rounded"><span class="text-xs text-gray-400">TOTAL ETAPAS</span><br><span class="text-xl font-bold text-blue-400">${dados.financeiro.totais.etapas}</span></div>
                </div>
                <table class="w-full text-xs text-gray-300"><thead class="bg-slate-900"><tr><th class="p-2 text-left">NOME</th><th class="p-2 text-right">HE</th><th class="p-2 text-right">VALOR</th></tr></thead><tbody>
                ${dados.financeiro.lista.map(m => `<tr><td class="p-2 border-b border-gray-700">${m.nomeCompleto}</td><td class="p-2 text-right border-b border-gray-700">${m.horasExtras}</td><td class="p-2 text-right border-b border-gray-700 font-bold text-green-400">${m.valor}</td></tr>`).join('')}
                </tbody></table>`;
                
                document.getElementById('modal-fin').classList.remove('hidden');
                
            } catch(e) { alert("Erro: " + e); }
            btn.innerHTML = '<i class="fas fa-save"></i> SALVAR';
        }

        function alternarVisao(modo) {
            if(modo === 'print') {
                gerarTabelaPrint();
                document.getElementById('view-print').classList.remove('hidden');
                document.getElementById('view-editor').classList.add('hidden');
            } else {
                document.getElementById('view-print').classList.add('hidden');
                document.getElementById('view-editor').classList.remove('hidden');
            }
        }

        function gerarTabelaPrint() {
            const pelotao = document.getElementById('sel-pelotao').value;
            document.getElementById('titulo-impresso').innerText = `ESCALA JANEIRO 2026 - ${pelotao}`;
            const tbody = document.getElementById('tabela-print-body');
            
            // Pega nomes escalados
            let nomes = new Set();
            for(let d=1; d<=31; d++) if(escalaTemp[d]) Object.values(escalaTemp[d]).forEach(n => nomes.add(n));
            let lista = Array.from(nomes).sort();

            tbody.innerHTML = lista.map(nome => {
                let cols = `<td class="text-left pl-2 font-bold">${nome}</td>`;
                for(let i=1; i<=31; i++) {
                    let trab = escalaTemp[i] && Object.values(escalaTemp[i]).includes(nome);
                    cols += trab ? `<td class="cell-24">24</td>` : `<td></td>`;
                }
                return `<tr>${cols}</tr>`;
            }).join('');
        }

        init();
    </script>
</body>
</html>

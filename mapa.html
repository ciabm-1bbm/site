<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAPA GERAL 1º BBM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: { extend: { colors: { 'fire-red': '#b71c1c', 'fire-yellow': '#FFD700', 'dark-bg': '#0f172a' } } }
        }
    </script>
    
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        /* TABELA DE DADOS */
        .master-table { border-collapse: separate; border-spacing: 0; width: 100%; font-size: 10px; }
        .master-table th { background: #1e293b; color: #FFD700; position: sticky; top: 0; z-index: 20; border: 1px solid #334155; height: 28px; }
        .master-table td { border: 1px solid #334155; height: 26px; padding: 0; position: relative; }
        
        /* COLUNAS ESPECIAIS */
        .col-nome { position: sticky; left: 0; background: #1e293b; z-index: 10; min-width: 180px; padding-left: 5px; font-weight: bold; border-right: 2px solid #475569; }
        .col-resumo { background: #0f172a; font-weight: bold; text-align: center; min-width: 40px; }
        .col-dinheiro { background: #0f172a; font-weight: bold; text-align: right; padding-right: 5px; color: #4ade80; min-width: 70px; }
        
        /* SEPARADOR DE PELOTÃO */
        .row-pelotao { background: #334155; color: white; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        .row-total-pel { background: #475569; color: #FFD700; font-weight: bold; text-align: right; }

        /* INPUTS */
        select.cell-in { width: 100%; height: 100%; background: transparent; border: none; color: white; text-align: center; -webkit-appearance: none; font-size: 9px; font-weight: bold; cursor: pointer; }
        select.cell-in:focus { background: #b71c1c; outline: none; }
        select.cell-in option { background: #1e293b; }

        /* CORES DE CÉLULA */
        .bg-24 { background-color: #15803d; }
        .bg-he { background-color: #b91c1c; }
        .bg-afast { background-color: #64748b; color: #cbd5e1; }

        /* SCROLL */
        #table-container { overflow: auto; height: calc(100vh - 80px); } /* Ajuste para rodapé */
        
        /* RODAPÉ TOTAL */
        footer { height: 40px; background: #000; border-top: 2px solid #FFD700; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 50; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <div id="loader" class="fixed inset-0 bg-slate-900 z-50 flex flex-col items-center justify-center">
        <i class="fas fa-spinner fa-spin text-4xl text-fire-yellow mb-2"></i>
        <p class="text-white font-bold">CARREGANDO MAPA GERAL...</p>
    </div>

    <header class="h-10 bg-slate-900 border-b border-white/10 flex items-center justify-between px-4 shrink-0">
        <div class="flex items-center gap-2">
            <h1 class="font-black text-white text-xs">MAPA GERAL 1º BBM</h1>
            <span class="bg-blue-600 text-white text-[10px] px-2 rounded">JANEIRO 2026</span>
        </div>
        <div>
            <button onclick="salvarTudo()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-1 rounded text-xs font-bold transition">
                <i class="fas fa-save mr-1"></i> SALVAR ALTERAÇÕES
            </button>
        </div>
    </header>

    <div id="table-container">
        <table class="master-table">
            <thead>
                <tr>
                    <th class="col-nome z-30">MILITAR / PELOTÃO</th>
                    <script>for(let i=1;i<=31;i++) document.write(`<th style="min-width:25px">${i}</th>`)</script>
                    <th class="col-resumo text-blue-300">ORD</th>
                    <th class="col-resumo text-red-300">HE</th>
                    <th class="col-resumo text-yellow-300">ETP</th>
                    <th class="col-dinheiro">VALOR HE</th>
                </tr>
            </thead>
            <tbody id="tabela-corpo">
                </tbody>
        </table>
    </div>

    <footer class="text-xs font-bold text-white">
        <div class="flex gap-4">
            <span>TOTAL BATALHÃO:</span>
            <span class="text-green-400">HE: <span id="grand-total-he">0</span>h (<span id="grand-total-val">R$ 0,00</span>)</span>
            <span class="text-blue-400">ETAPAS: <span id="grand-total-etp">0</span></span>
        </div>
        <div class="text-[9px] text-gray-500">SISTEMA C2 v11.0</div>
    </footer>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxrGmzUMT2C_PWQjy-bRzv0SZmBjZ7bxjurfTfPYmmaC3O5feQhq0XdsJH5NgjE2x1D/exec"; // <--- COLE SUA URL

        // DADOS GLOBAIS
        let DB = {
            efetivo: [],
            precos: {},
            config: {},
            escala: {} // { "NOME": { 1: "24", 5: "12D" } }
        };

        const OPCOES_TURNO = ["", "24", "12D", "12N", "A07", "LTS", "FER", "F"];
        const VALORES_HORA = { "24":24, "12D":12, "12N":12, "A07":7, "LTS":5.71, "FER":5.71, "F":0 };

        async function init() {
            try {
                const res = await fetch(`${API_URL}?action=getInitData`);
                const dados = await res.json();
                
                DB.efetivo = dados.efetivo;
                DB.precos = dados.precos;
                DB.config = dados.config;
                DB.escala = dados.escalaSalva || {};

                renderizarTabela();
                document.getElementById('loader').classList.add('hidden');
                
            } catch (e) { alert("Erro ao carregar: " + e); }
        }

        function renderizarTabela() {
            const tbody = document.getElementById('tabela-corpo');
            tbody.innerHTML = "";

            // Agrupar por Pelotão
            const pelotoes = [...new Set(DB.efetivo.map(m => m.pelotao))].sort();

            // Totais Globais
            let grandHE = 0, grandVal = 0, grandEtp = 0;

            pelotoes.forEach(pel => {
                if(pel === "GERAL") return;

                // Cabeçalho do Pelotão
                tbody.innerHTML += `
                <tr class="row-pelotao">
                    <td class="col-nome bg-slate-700 pl-2 py-1" colspan="36">${pel}</td>
                </tr>`;

                const militares = DB.efetivo.filter(m => m.pelotao === pel);
                let subHE = 0, subVal = 0, subEtp = 0;

                militares.forEach(mil => {
                    // Calcula linha
                    const stats = calcularMilitar(mil.nome, mil.posto);
                    
                    // Soma aos subtotais
                    subHE += stats.he;
                    subVal += stats.val;
                    subEtp += stats.etp;

                    // Renderiza Linha
                    let tr = document.createElement('tr');
                    
                    // Coluna Nome Fixa
                    let tdNome = document.createElement('td');
                    tdNome.className = "col-nome text-[9px] border-r";
                    tdNome.innerHTML = `<span class="text-gray-400">${mil.posto}</span><br>${mil.nome}`;
                    tr.appendChild(tdNome);

                    // Dias 1-31
                    for(let i=1; i<=31; i++) {
                        let td = document.createElement('td');
                        let valAtual = (DB.escala[mil.nome] && DB.escala[mil.nome][i]) ? DB.escala[mil.nome][i] : "";
                        
                        // Classe de cor baseada no valor
                        if(valAtual === "24") td.className = "bg-24";
                        else if(valAtual.includes("12") || valAtual === "A07") td.className = "bg-he";
                        else if(["LTS","FER"].includes(valAtual)) td.className = "bg-afast";

                        let sel = document.createElement('select');
                        sel.className = "cell-in";
                        // Popula opções (simplificado para performance)
                        sel.innerHTML = `<option value="${valAtual}">${valAtual}</option>` + 
                                        OPCOES_TURNO.filter(o => o !== valAtual).map(o => `<option value="${o}">${o}</option>`).join('');
                        
                        // Evento de Mudança
                        sel.onchange = function() { 
                            atualizarEscala(mil.nome, i, this.value, td); 
                        };
                        
                        td.appendChild(sel);
                        tr.appendChild(td);
                    }

                    // Colunas de Totais (IDs únicos para atualização via JS)
                    const idBase = mil.nome.replace(/\s+/g, '_');
                    tr.innerHTML += `
                        <td class="col-resumo text-gray-400" id="ord_${idBase}">${Math.floor(stats.ord)}</td>
                        <td class="col-resumo text-red-400" id="he_${idBase}">${stats.he.toFixed(1)}</td>
                        <td class="col-resumo text-yellow-400" id="etp_${idBase}">${stats.etp}</td>
                        <td class="col-dinheiro" id="val_${idBase}">${stats.valFmt}</td>
                    `;
                    
                    tbody.appendChild(tr);
                });

                // Rodapé do Pelotão (Subtotal)
                const idPel = pel.replace(/\s+/g, '_');
                tbody.innerHTML += `
                <tr class="row-total-pel text-[9px]">
                    <td class="col-nome bg-slate-800 text-right pr-2">TOTAL ${pel}:</td>
                    <td colspan="31"></td>
                    <td class="col-resumo text-center">-</td>
                    <td class="col-resumo text-center" id="sub_he_${idPel}">${subHE.toFixed(1)}</td>
                    <td class="col-resumo text-center" id="sub_etp_${idPel}">${subEtp}</td>
                    <td class="col-dinheiro" id="sub_val_${idPel}">R$ ${subVal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                </tr>`;

                grandHE += subHE;
                grandVal += subVal;
                grandEtp += subEtp;
            });

            atualizarGrandTotal(grandHE, grandEtp, grandVal);
        }

        // --- CÁLCULOS ---
        function calcularMilitar(nome, posto) {
            let dadosEscala = DB.escala[nome] || {};
            let horasReais = 0; // Para Etapa
            let horasGSE = 0;   // Para Dinheiro
            
            for(let i=1; i<=31; i++) {
                let cod = dadosEscala[i];
                let val = VALORES_HORA[cod] || 0;
                if(val > 0) {
                    if(["LTS","FER"].includes(cod)) {
                        horasGSE += val;
                    } else {
                        horasReais += val;
                        horasGSE += val;
                    }
                }
            }

            // Regras
            const carga = DB.config.cargaMensal;
            
            // Etapas (Teto 177h)
            let baseEtapa = Math.min(horasReais, carga);
            let etapas = Math.floor(baseEtapa / 6);

            // GSE
            let saldo = horasGSE - carga;
            let he = saldo > 0 ? saldo : 0;
            let ord = horasGSE - he;

            // Valor
            // Tenta casar o posto com a tabela de preços (busca aproximada)
            let preco = 0;
            for (const [key, value] of Object.entries(DB.precos)) {
                if(posto.includes(key) || key.includes(posto)) { preco = value; break; }
            }
            let totalVal = he * preco;

            return {
                ord: ord,
                he: he,
                etp: etapas,
                val: totalVal,
                valFmt: totalVal.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})
            };
        }

        function atualizarEscala(nome, dia, valor, tdElement) {
            // Atualiza Memória
            if(!DB.escala[nome]) DB.escala[nome] = {};
            
            if(valor === "") delete DB.escala[nome][dia];
            else DB.escala[nome][dia] = valor;

            // Atualiza Cor da Célula
            tdElement.className = "";
            if(valor === "24") tdElement.className = "bg-24";
            else if(valor.includes("12") || valor === "A07") tdElement.className = "bg-he";
            else if(["LTS","FER"].includes(valor)) tdElement.className = "bg-afast";

            // Recalcula Totais da Linha e Globais (Sem recarregar tudo)
            // Para simplificar neste exemplo, vamos recarregar a tabela toda
            // (Em produção, faríamos update pontual dos IDs)
            renderizarTabela(); 
        }

        function atualizarGrandTotal(he, etp, val) {
            document.getElementById('grand-total-he').innerText = he.toFixed(1);
            document.getElementById('grand-total-etp').innerText = etp;
            document.getElementById('grand-total-val').innerText = val.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
        }

        async function salvarTudo() {
            const btn = document.querySelector('button[onclick="salvarTudo()"]');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SALVANDO...';
            
            // Transforma objeto escala em lista para o backend
            let payload = [];
            for (const [nome, dias] of Object.entries(DB.escala)) {
                for (const [dia, codigo] of Object.entries(dias)) {
                    payload.push({ nome: nome, dia: dia, codigo: codigo });
                }
            }

            try {
                await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                alert("Dados salvos e sincronizados com a planilha!");
            } catch(e) { alert("Erro ao salvar: " + e); }
            
            btn.innerHTML = '<i class="fas fa-save mr-1"></i> SALVAR ALTERAÇÕES';
        }

        init();
    </script>
</body>
</html>

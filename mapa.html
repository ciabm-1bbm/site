<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA C2 - 1º BBM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: { extend: { colors: { 'fire-red': '#b71c1c', 'fire-yellow': '#FFD700', 'dark-bg': '#0f172a' } } }
        }
    </script>
    
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        .master-table { border-collapse: separate; border-spacing: 0; width: 100%; font-size: 10px; }
        .master-table th { background: #1e293b; color: #FFD700; position: sticky; top: 0; z-index: 20; border: 1px solid #334155; height: 28px; }
        .master-table td { border: 1px solid #334155; height: 26px; padding: 0; position: relative; }
        .col-nome { position: sticky; left: 0; background: #1e293b; z-index: 10; min-width: 180px; padding-left: 5px; font-weight: bold; border-right: 2px solid #475569; }
        .row-pelotao { background: #334155; color: white; font-weight: bold; text-transform: uppercase; }
        .bg-24 { background-color: #15803d; }
        .bg-he { background-color: #b91c1c; }
        .bg-afast { background-color: #64748b; color: #cbd5e1; }
        #table-container { overflow: auto; height: calc(100vh - 80px); }
        select.cell-in { width: 100%; height: 100%; background: transparent; border: none; color: white; text-align: center; font-size: 9px; cursor: pointer; }
        select.cell-in option { background: #1e293b; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <div id="loader" class="fixed inset-0 bg-slate-900 z-50 flex flex-col items-center justify-center">
        <i class="fas fa-sync fa-spin text-4xl text-fire-yellow mb-2"></i>
        <p class="text-white font-bold" id="msg-loader">SINCRONIZANDO COM DRIVE...</p>
    </div>

    <header class="h-10 bg-slate-900 border-b border-white/10 flex items-center justify-between px-4 shrink-0">
        <div class="flex items-center gap-2">
            <h1 class="font-black text-white text-xs">MAPA GERAL (DRIVE)</h1>
            <span class="bg-blue-600 text-white text-[10px] px-2 rounded">JANEIRO 2026</span>
        </div>
        <div>
            <button onclick="salvarTudo()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-1 rounded text-xs font-bold transition shadow-lg">
                <i class="fas fa-cloud-upload-alt mr-1"></i> SALVAR NO DRIVE
            </button>
        </div>
    </header>

    <div id="table-container">
        <table class="master-table">
            <thead>
                <tr>
                    <th class="col-nome z-30">MILITAR / PELOTÃO</th>
                    <script>for(let i=1;i<=31;i++) document.write(`<th style="min-width:28px">${i}</th>`)</script>
                    <th class="bg-slate-900 text-blue-300 min-w-[40px]">ORD</th>
                    <th class="bg-slate-900 text-red-300 min-w-[40px]">HE</th>
                    <th class="bg-slate-900 text-yellow-300 min-w-[40px]">ETP</th>
                    <th class="bg-slate-900 text-green-300 min-w-[70px]">VALOR</th>
                </tr>
            </thead>
            <tbody id="tabela-corpo"></tbody>
        </table>
    </div>

    <footer class="h-10 bg-black border-t border-yellow-600 flex items-center justify-between px-4 text-xs font-bold text-white shrink-0">
        <div>TOTAL GERAL:</div>
        <div class="flex gap-4">
            <span class="text-green-400">HE: <span id="gt-he">0</span>h (<span id="gt-val">R$ 0,00</span>)</span>
            <span class="text-blue-400">ETAPAS: <span id="gt-etp">0</span></span>
        </div>
    </footer>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwBQyzXFjnIdWQ0xRIXDxv0iJYGXM2YfCbZzHi4yP1MEa-l0yw6xQlBSsWT_j10Jy5J/exec"; // <--- COLE SUA URL

        let DB = { efetivo: [], precos: {}, config: {}, escala: {} };
        const OPCOES = ["", "24", "12D", "12N", "A07", "LTS", "FER"];
        
        // Controle de alterações para salvar apenas o necessário (opcional, aqui salvamos por pelotão)
        let pelotoesAlterados = new Set(); 

        async function init() {
            try {
                const res = await fetch(`${API_URL}?action=getInitData`);
                const dados = await res.json();
                DB = { ...dados, escala: dados.escalaSalva || {} };
                renderizar();
                document.getElementById('loader').classList.add('hidden');
            } catch (e) { alert("Erro de conexão: " + e); }
        }

        function renderizar() {
            const tbody = document.getElementById('tabela-corpo');
            tbody.innerHTML = "";
            const pelotoes = [...new Set(DB.efetivo.map(m => m.pelotao))].sort();
            
            let gtHE=0, gtVal=0, gtEtp=0;

            pelotoes.forEach(pel => {
                if(pel === "GERAL") return;
                
                // Cabeçalho Pelotão
                tbody.innerHTML += `<tr class="row-pelotao"><td class="col-nome pl-2 py-1" colspan="36">${pel}</td></tr>`;
                
                const militares = DB.efetivo.filter(m => m.pelotao === pel);
                let subHE=0, subVal=0, subEtp=0;

                militares.forEach(mil => {
                    const stats = calcular(mil.nome, mil.posto);
                    subHE += stats.he; subVal += stats.val; subEtp += stats.etp;

                    let tr = document.createElement('tr');
                    // Nome Fixo
                    tr.innerHTML = `<td class="col-nome text-[9px] border-r"><span class="text-gray-400">${mil.posto}</span><br>${mil.nome}</td>`;
                    
                    // Dias
                    for(let i=1; i<=31; i++) {
                        let td = document.createElement('td');
                        let val = (DB.escala[mil.nome] && DB.escala[mil.nome][i]) || "";
                        
                        if(val === "24") td.className = "bg-24";
                        else if(val.includes("12") || val === "A07") td.className = "bg-he";
                        else if(["LTS","FER"].includes(val)) td.className = "bg-afast";

                        let sel = document.createElement('select');
                        sel.className = "cell-in";
                        sel.innerHTML = `<option value="${val}">${val}</option>` + OPCOES.filter(o=>o!==val).map(o=>`<option value="${o}">${o}</option>`).join('');
                        
                        sel.onchange = function() {
                            if(!DB.escala[mil.nome]) DB.escala[mil.nome] = {};
                            DB.escala[mil.nome][i] = this.value;
                            if(this.value === "") delete DB.escala[mil.nome][i];
                            
                            // Marca o pelotão como alterado para salvar
                            pelotoesAlterados.add(pel);
                            renderizar(); // Atualiza totais (pode otimizar depois)
                        };
                        td.appendChild(sel);
                        tr.appendChild(td);
                    }
                    
                    // Totais Linha
                    tr.innerHTML += `
                        <td class="text-center text-blue-300 font-bold bg-slate-800">${Math.floor(stats.ord)}</td>
                        <td class="text-center text-red-300 font-bold bg-slate-800">${stats.he.toFixed(0)}</td>
                        <td class="text-center text-yellow-300 font-bold bg-slate-800">${stats.etp}</td>
                        <td class="text-right pr-2 text-green-300 font-bold bg-slate-800">${stats.valFmt}</td>`;
                    tbody.appendChild(tr);
                });

                // Rodapé Pelotão
                tbody.innerHTML += `<tr class="bg-slate-700 text-white font-bold text-[9px]"><td class="col-nome text-right pr-2">TOTAL ${pel}:</td><td colspan="31"></td><td class="text-center">-</td><td class="text-center text-red-300">${subHE.toFixed(0)}</td><td class="text-center text-yellow-300">${subEtp}</td><td class="text-right pr-2 text-green-300">R$ ${subVal.toLocaleString('pt-BR',{minimumFractionDigits:2})}</td></tr>`;
                
                gtHE+=subHE; gtVal+=subVal; gtEtp+=subEtp;
            });

            document.getElementById('gt-he').innerText = gtHE.toFixed(0);
            document.getElementById('gt-etp').innerText = gtEtp;
            document.getElementById('gt-val').innerText = gtVal.toLocaleString('pt-BR',{style:'currency', currency:'BRL'});
        }

        function calcular(nome, posto) {
            let dados = DB.escala[nome] || {};
            let hReais=0, hGSE=0;
            const vals = {"24":24, "12D":12, "12N":12, "A07":7, "LTS":5.71, "FER":5.71};
            
            for(let i=1; i<=31; i++) {
                let v = vals[dados[i]] || 0;
                if(v > 0) {
                    if(["LTS","FER"].includes(dados[i])) hGSE += v;
                    else { hReais += v; hGSE += v; }
                }
            }
            
            let baseEtp = Math.min(hReais, DB.config.cargaMensal);
            let etp = Math.floor(baseEtp / 6);
            let saldo = hGSE - DB.config.cargaMensal;
            let he = saldo > 0 ? saldo : 0;
            let ord = hGSE - he;
            
            let preco = 0;
            for(const [k,v] of Object.entries(DB.precos)) if(posto.includes(k) || k.includes(posto)) { preco = v; break; }
            let val = he * preco;

            return { ord:ord, he:he, etp:etp, val:val, valFmt: val.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) };
        }

        async function salvarTudo() {
            const btn = document.querySelector('button');
            const icon = btn.querySelector('i');
            const originalText = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SALVANDO...';

            // Salva todos os pelotões que existem no DB.escala
            // Para otimizar, poderiamos salvar apenas 'pelotoesAlterados', mas vamos garantir tudo por segurança
            
            const pelotoes = [...new Set(DB.efetivo.map(m => m.pelotao))];
            
            try {
                // Processamento Serial para não sobrecarregar o script
                for (const pel of pelotoes) {
                    if(pel === "GERAL") continue;
                    
                    // Filtra dados deste pelotão
                    let dadosPelotao = [];
                    const militares = DB.efetivo.filter(m => m.pelotao === pel);
                    
                    militares.forEach(mil => {
                        if(DB.escala[mil.nome]) {
                            for(const [dia, cod] of Object.entries(DB.escala[mil.nome])) {
                                dadosPelotao.push({ nome: mil.nome, dia: dia, codigo: cod });
                            }
                        }
                    });

                    // Só envia se tiver dados
                    if(dadosPelotao.length > 0) {
                        await fetch(API_URL, {
                            method: 'POST',
                            body: JSON.stringify({ pelotao: pel, dados: dadosPelotao })
                        });
                    }
                }
                
                alert("Todas as escalas foram salvas no Drive!");
                pelotoesAlterados.clear();
                
            } catch(e) {
                alert("Erro ao salvar: " + e);
            }
            
            btn.disabled = false;
            btn.innerHTML = originalText;
        }

        init();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA ESCALA 1º BBM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: { extend: { colors: { 'fire-red': '#b71c1c', 'fire-yellow': '#FFD700', 'dark-bg': '#0f172a' } } }
        }
    </script>
    
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', sans-serif; }
        .glass-panel { background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 0.5rem; margin-bottom: 20px; }
        
        /* Tabela Editor */
        .editor-table { width: 100%; border-collapse: separate; border-spacing: 2px; }
        .editor-table th { background: #1e293b; color: #94a3b8; font-size: 10px; padding: 4px; border-radius: 2px; }
        .editor-table td { background: #334155; padding: 0; border: 1px solid #475569; position: relative; height: 32px; border-radius: 2px; }
        
        select.cell-in { width: 100%; height: 100%; background: transparent; border: none; color: white; font-size: 10px; text-align: center; cursor: pointer; appearance: none; }
        select.cell-in option { background: #1e293b; }
        select.cell-in:focus { background: #000; outline: 2px solid #FFD700; }

        /* Impressão */
        @media print {
            @page { size: landscape; margin: 5mm; }
            body { background: white; color: black; font-family: 'Arial', sans-serif; }
            .no-print, header, #editor-area, #msg-start { display: none !important; }
            #print-area { display: block !important; }
            table { width: 100%; border-collapse: collapse; font-size: 8pt; margin-bottom: 20px; page-break-inside: avoid; }
            th, td { border: 1px solid black; padding: 3px; text-align: center; }
            .bg-filled { background-color: #ddd !important; -webkit-print-color-adjust: exact; font-weight: bold; }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-slate-900 border-b border-white/10 p-3 sticky top-0 z-50 shadow-lg no-print">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            
            <div class="flex items-center gap-3">
                <i class="fas fa-fire-extinguisher text-fire-yellow text-3xl"></i>
                <div>
                    <h1 class="font-black text-white text-lg leading-none">ESCALA 1º BBM</h1>
                    <h2 class="text-xs text-gray-400 font-bold tracking-widest">SISTEMA INTEGRADO</h2>
                </div>
            </div>
            
            <div class="flex items-center gap-3 bg-slate-800 p-2 rounded-lg border border-slate-700">
                
                <div class="flex flex-col">
                    <label class="text-[9px] text-gray-400 font-bold uppercase">PELOTÃO</label>
                    <select id="sel-pelotao" class="bg-slate-700 text-white text-xs font-bold border border-slate-600 rounded w-40 h-7" onchange="carregarPelotao()">
                        <option value="">Carregando...</option>
                    </select>
                </div>

                <div class="w-px h-8 bg-white/10"></div>

                <div class="flex items-end gap-2">
                    <div class="flex flex-col">
                        <label class="text-[9px] text-gray-400 font-bold uppercase">CICLO</label>
                        <select id="sel-ciclo" class="bg-slate-900 text-white text-xs border border-slate-600 rounded h-7 w-24 text-center">
                            <option value="4">24x72 (4d)</option>
                            <option value="2">24x48 (2d)</option>
                        </select>
                    </div>
                    <button onclick="replicarEscala()" class="bg-yellow-600 hover:bg-yellow-500 text-white px-3 py-1 rounded h-7 text-xs font-bold shadow transition flex items-center" title="Preencher mês automaticamente">
                        <i class="fas fa-bolt mr-1"></i> REPLICAR
                    </button>
                </div>

                <div class="w-px h-8 bg-white/10"></div>

                <button onclick="window.print()" class="bg-slate-600 hover:bg-slate-500 text-white px-4 py-1 rounded h-8 text-xs font-bold transition">
                    <i class="fas fa-print mr-2"></i> IMPRIMIR
                </button>
                <button onclick="salvarDrive()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-1 rounded h-8 text-xs font-bold shadow-lg transition flex items-center">
                    <i class="fas fa-save mr-2"></i> SALVAR DRIVE
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 flex-grow w-full max-w-[98%]">
        
        <div id="msg-start" class="text-center py-32 text-gray-500">
            <i class="fas fa-arrow-up text-5xl mb-4 animate-bounce text-slate-700"></i><br>
            <span class="text-xl font-bold">Selecione o Pelotão acima.</span>
        </div>

        <div id="editor-area" class="hidden no-print space-y-4">
            </div>

        <div id="print-area" class="hidden">
            <div class="text-center border-b-2 border-black pb-2 mb-4">
                <h2 class="font-bold text-lg">ESTADO DO RIO GRANDE DO SUL - SECRETARIA DA SEGURANÇA PÚBLICA</h2>
                <h3 class="font-bold text-md">CORPO DE BOMBEIROS MILITAR - 1º BBM</h3>
                <p class="font-bold text-sm mt-2" id="titulo-imp">ESCALA DE SERVIÇO</p>
            </div>
            <div id="tabelas-imp"></div>
            <div class="flex justify-around mt-10 border-t border-gray-300 pt-8 text-xs">
                <div class="border-t border-black w-1/3 text-center pt-1">Sargenteante</div>
                <div class="border-t border-black w-1/3 text-center pt-1">Comandante</div>
            </div>
        </div>

    </main>

    <div id="loader" class="fixed inset-0 bg-slate-900 z-[100] flex flex-col items-center justify-center">
        <i class="fas fa-spinner fa-spin text-5xl text-fire-yellow mb-4"></i>
        <p class="text-white font-bold tracking-widest">CARREGANDO DADOS...</p>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwiT5KKzNMjDbocRztRHNoTJmapxV-9KqmYl-9h5BP68izpdc5NEieN_phInkCZk-66/exec"; // <--- COLE SUA URL

        let DB = { efetivo: [], escala: {} };
        let visual = {}; // { 1: {CG:'xxx', COV:'yyy'} }
        let pelotaoAtual = "";
        
        const FUNCOES = [
            {id:'CG', label:'Cmt. Guarnição'},
            {id:'COV', label:'Motorista (COV)'},
            {id:'CB1', label:'Combatente 1'},
            {id:'CB2', label:'Combatente 2'}
        ];

        async function init() {
            try {
                const res = await fetch(`${API_URL}?action=getInitData`);
                const dados = await res.json();
                DB.efetivo = dados.efetivo;
                // Carrega escala salva se houver
                if(dados.escalaSalva) {
                    // Converter de {Nome:{Dia:Cod}} para {Dia:{Func:Nome}}
                    // Isso requer heurística pois não salvamos a função.
                    // Para simplificar, iniciamos limpo para montagem manual/replicação
                }
                
                const sel = document.getElementById('sel-pelotao');
                const p = [...new Set(DB.efetivo.map(m=>m.pelotao))].sort();
                sel.innerHTML = '<option value="">SELECIONE...</option>';
                p.forEach(x => { if(x!=="GERAL") sel.add(new Option(x,x)); });
                
                document.getElementById('loader').classList.add('hidden');
            } catch(e) { alert("Erro de conexão."); }
        }

        function carregarPelotao() {
            pelotaoAtual = document.getElementById('sel-pelotao').value;
            if(!pelotaoAtual) {
                document.getElementById('msg-start').classList.remove('hidden');
                document.getElementById('editor-area').classList.add('hidden');
                return;
            }
            
            document.getElementById('msg-start').classList.add('hidden');
            document.getElementById('editor-area').classList.remove('hidden');
            visual = {}; // Reseta visual
            renderizarEditor();
        }

        function renderizarEditor() {
            const area = document.getElementById('editor-area');
            area.innerHTML = "";
            const semanas = [{i:1, f:8}, {i:9, f:16}, {i:17, f:24}, {i:25, f:31}];

            semanas.forEach(sem => {
                let html = `
                <div class="glass-panel p-2">
                    <table class="editor-table">
                        <thead>
                            <tr>
                                <th style="width:100px; background:transparent"></th>
                                ${gerarCabecalho(sem.i, sem.f)}
                            </tr>
                        </thead>
                        <tbody>`;
                
                FUNCOES.forEach(f => {
                    html += `<tr>
                        <td style="color:#FFD700; font-weight:bold; font-size:9px; text-align:right; padding-right:8px; background:#0f172a; border:none;">${f.label}</td>
                        ${gerarCelulas(sem.i, sem.f, f.id)}
                    </tr>`;
                });
                
                html += `</tbody></table></div>`;
                area.innerHTML += html;
            });
        }

        function gerarCabecalho(i, f) {
            let s=""; for(;i<=f;i++) s+=`<th>DIA ${i}</th>`; return s;
        }

        function gerarCelulas(i, f, funcId) {
            let s="";
            for(;i<=f;i++) {
                s += `<td>${criarSelect(i, funcId)}</td>`;
            }
            return s;
        }

        function criarSelect(dia, funcId) {
            let opts = DB.efetivo.filter(m => m.pelotao === pelotaoAtual);
            if(funcId === 'COV') opts = opts.filter(m => m.funcao.includes('COV'));
            opts.sort((a,b) => a.nome.localeCompare(b.nome));

            let html = `<select class="cell-in" id="d${dia}-${funcId}" onchange="atualizar(${dia}, '${funcId}', this.value)">`;
            html += `<option value="">-</option>`;
            opts.forEach(m => {
                html += `<option value="${m.nome}">${m.posto} ${m.nome}</option>`;
            });
            html += `</select>`;
            return html;
        }

        function atualizar(dia, funcId, nome) {
            if(!visual[dia]) visual[dia] = {};
            if(nome) visual[dia][funcId] = nome;
            else delete visual[dia][funcId];
        }

        // --- AUTOMAÇÃO: REPLICAR ---
        function replicarEscala() {
            if(!pelotaoAtual) return alert("Selecione um pelotão.");
            const ciclo = parseInt(document.getElementById('sel-ciclo').value);
            
            for(let d = ciclo + 1; d <= 31; d++) {
                const origem = d - ciclo;
                if(visual[origem]) {
                    FUNCOES.forEach(f => {
                        const nome = visual[origem][f.id];
                        if(nome) {
                            // Atualiza Memória
                            if(!visual[d]) visual[d] = {};
                            visual[d][f.id] = nome;
                            // Atualiza Tela
                            const el = document.getElementById(`d${d}-${f.id}`);
                            if(el) el.value = nome;
                        }
                    });
                }
            }
            alert("Escala replicada com sucesso! Verifique os dias.");
        }

        // --- IMPRESSÃO ---
        window.onbeforeprint = function() {
            if(!pelotaoAtual) return;
            const div = document.getElementById('tabelas-imp');
            document.getElementById('titulo-imp').innerText = `ESCALA DE SERVIÇO - JANEIRO 2026 - ${pelotaoAtual}`;
            div.innerHTML = "";
            
            const semanas = [{i:1, f:8}, {i:9, f:16}, {i:17, f:24}, {i:25, f:31}];
            semanas.forEach(sem => {
                let html = `<table style="width:100%; border-collapse:collapse; font-size:8pt; margin-bottom:15px; page-break-inside:avoid;">
                    <thead>
                        <tr style="background:#eee; font-weight:bold;">
                            <th style="border:1px solid black; width:100px;">TURNO</th>
                            ${printHeader(sem.i, sem.f)}
                        </tr>
                    </thead>
                    <tbody>`;
                FUNCOES.forEach(f => {
                    html += `<tr><td style="border:1px solid black; font-weight:bold; padding:2px;">${f.label}</td>`;
                    for(let d=sem.i; d<=sem.f; d++) {
                        let nome = (visual[d] && visual[d][f.id]) || "";
                        html += `<td style="border:1px solid black; text-align:center; padding:2px; ${nome?'background:#ddd; font-weight:bold;':''}">${nome}</td>`;
                    }
                    html += `</tr>`;
                });
                html += `</tbody></table>`;
                div.innerHTML += html;
            });
        };
        function printHeader(i,f) { let s=""; for(;i<=f;i++) s+=`<th style="border:1px solid black;">${i}/01</th>`; return s; }

        // --- SALVAR NO DRIVE ---
        async function salvarDrive() {
            if(!pelotaoAtual) return alert("Selecione um pelotão.");
            const btn = document.querySelector('button[onclick="salvarDrive()"]');
            const txt = btn.innerHTML;
            btn.innerHTML = "SALVANDO..."; btn.disabled = true;

            // Prepara Payload Completo
            let payload = [];
            for(let d=1; d<=31; d++) {
                if(visual[d]) {
                    Object.keys(visual[d]).forEach(fid => {
                        let nome = visual[d][fid];
                        // Busca posto
                        let militar = DB.efetivo.find(m => m.nome === nome);
                        let posto = militar ? militar.posto : "";
                        payload.push({ nome: nome, posto: posto, dia: d, codigo: "24" });
                    });
                }
            }
            
            if(payload.length === 0) {
                if(!confirm("Escala vazia. Salvar mesmo assim?")) {
                    btn.innerHTML = txt; btn.disabled = false; return;
                }
            }

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ pelotao: pelotaoAtual, dados: payload })
                });
                const msg = await res.text();
                alert(msg); // Mostra "Salvo com sucesso! Totais calculados."
            } catch(e) { alert("Erro: " + e); }

            btn.innerHTML = txt; btn.disabled = false;
        }

        init();
    </script>
</body>
</html>

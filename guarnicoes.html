// ==UserScript==
// @name         Coletor E193 - V33 (InjeÃ§Ã£o Direta)
// @namespace    http://tampermonkey.net/
// @version      33.0
// @description  Usa o motor do site (jQuery) para forÃ§ar o login e o filtro.
// @author       Expert
// @match        *://e193.cbm.rs.gov.br/*
// @match        *://www.e193.cbm.rs.gov.br/*
// @grant        GM_xmlhttpRequest
// @grant        unsafeWindow
// @run-at       document-end
// ==/UserScript==

(function() {
    'use strict';

    // DADOS
    const URL_PONTE = "https://script.google.com/macros/s/AKfycbytTWRqDymoXymP03pKWZlaQL7artZiBKahsg8Xu5cOg4j5AEQBTKcqy9olSGgqwK17/exec";
    const USER = "2822130";
    const PASS = "E193@Gus";

    // STATUS
    const statusBox = document.createElement('div');
    statusBox.style = "position:fixed; bottom:15px; right:15px; background:red; color:#fff; padding:15px; z-index:9999999; font-weight:bold; font-family:sans-serif; border:2px solid #fff; text-align:center;";
    statusBox.id = "robo_status";
    statusBox.innerText = "ðŸ¤– V33: INICIANDO";
    document.body.appendChild(statusBox);

    function log(txt) {
        const el = document.getElementById("robo_status");
        if(el) {
            el.innerText = "ðŸ¤– " + txt;
            el.style.background = txt.includes("SUCESSO") ? "green" : "blue";
        }
    }

    // =================================================================
    // LOOP PRINCIPAL (1s)
    // =================================================================
    setInterval(() => {
        const url = window.location.href;
        
        // ELEMENTOS
        const senhaEl = document.querySelector('input[name="senha"]'); // SÃ³ existe no login
        const tabela = document.getElementById('lista_escala');        // SÃ³ existe na escala
        const menu = document.getElementById('main_navbar');           // SÃ³ existe logado

        // 1. TELA DE LOGIN (PRIORIDADE TOTAL)
        if (senhaEl) {
            rotinaLogin();
        }
        // 2. NA ESCALA
        else if (tabela) {
            rotinaEscala(tabela);
        }
        // 3. LOGADO (HOME) -> IR PRA ESCALA
        else if (menu && !url.includes('cons_guarnicao.php')) {
            log("INDO PARA O MÃ“DULO...");
            if(typeof unsafeWindow.loadModulo === 'function') {
                unsafeWindow.loadModulo('gua', '23', 'cons_guarnicao.php');
            } else {
                const link = document.querySelector('a[href*="cons_guarnicao.php"]');
                if(link) link.click();
            }
        }

    }, 1000);

    // Recarrega a cada 5 min
    setTimeout(() => location.reload(), 300000);


    // =================================================================
    // 1. LOGIN (FORÃ‡A BRUTA VIA JQUERY)
    // =================================================================
    let tentouLogin = false;

    function rotinaLogin() {
        if(tentouLogin) return;
        
        log("PREENCHENDO LOGIN...");
        
        // Tenta usar o jQuery do site ($) para preencher
        // Isso Ã© infalÃ­vel em sites Semantic UI
        if (typeof unsafeWindow.jQuery !== 'undefined') {
            const $ = unsafeWindow.jQuery;
            
            // 1. Define valor e dispara gatilho
            $('input[name="usuario"]').val(USER).trigger('change');
            $('input[name="senha"]').val(PASS).trigger('change');
            
            // 2. Clica no botÃ£o
            setTimeout(() => {
                log("CLICANDO ENTRAR...");
                const btn = $('button[type="submit"]');
                if(btn.length > 0) btn.click();
                else document.querySelector('form').submit(); // Fallback
                
                tentouLogin = true;
                // Destrava depois de 5s caso falhe
                setTimeout(() => { tentouLogin = false; }, 5000);
            }, 500);

        } else {
            // Se o jQuery falhar, usa Javascript Puro
            const u = document.querySelector('input[name="usuario"]');
            const p = document.querySelector('input[name="senha"]');
            if(u && p) {
                u.value = USER;
                p.value = PASS;
                // Dispara eventos manuais
                u.dispatchEvent(new Event('input', {bubbles:true}));
                p.dispatchEvent(new Event('change', {bubbles:true}));
                
                document.querySelector('button[type="submit"]').click();
            }
        }
    }

    // =================================================================
    // 2. ESCALA (FILTRAR E LER)
    // =================================================================
    let travado = false;
    let ultimoEnvio = 0;

    function rotinaEscala(tabela) {
        const linhas = tabela.querySelectorAll('tr').length;
        const visivel = !tabela.classList.contains('d-none');

        // SE VAZIO -> FILTRA
        if ((linhas < 5 || !visivel) && !travado) {
            log("FILTRANDO...");
            travado = true;

            // Define Cidade POA via jQuery
            if (typeof unsafeWindow.jQuery !== 'undefined') {
                unsafeWindow.jQuery('#id_cidade').val("325").trigger('change');
            } else {
                const c = document.getElementById('id_cidade');
                if(c) c.value = "325";
            }

            // Clica Filtrar
            const btn = document.querySelector('input[value="Filtrar"]');
            if(btn) btn.click();
            else if(typeof unsafeWindow.loadEscalas === 'function') unsafeWindow.loadEscalas();

            setTimeout(() => { travado = false; }, 10000);
        }
        
        // SE CHEIO -> ENVIA
        else if (linhas > 5 && visivel) {
            lerDados(tabela);
        }
    }

    function lerDados(tabela) {
        const agora = new Date().getTime();
        if (agora - ultimoEnvio < 20000) return;

        log("ENVIANDO DADOS...");

        const linhas = tabela.querySelectorAll('tr');
        const dados = [];
        let obm = "GERAL", vtr = "IND";

        linhas.forEach(tr => {
            if(tr.className.includes('dtrg-level-1')) obm = tr.innerText.trim();
            else if(tr.className.includes('dtrg-level-2')) vtr = tr.innerText.split('(')[0].trim();
            else if(tr.className.includes('odd') || tr.className.includes('even')) {
                const tds = tr.querySelectorAll('td');
                let nome="ND", func="ND", horarios=[];

                tds.forEach(td => {
                    let txt = td.innerText.trim();
                    if(txt.match(/^\d{2}:\d{2}$/)) horarios.push(txt);
                    else if(txt.match(/^(\d+\s*)?([123]Âº\s*)?(SD|CB|SGT|TEN|CAP|MAJ|TC|CEL|ASP|SUB)/)) nome = txt;
                    else if(txt.length > 3 && !txt.match(/^\d+$/)) func = txt;
                });

                if(nome === "ND") {
                    const noVis = tr.querySelector('.noVis');
                    if(noVis) nome = noVis.innerText.trim();
                }

                let turno = "08:00 - 08:00";
                if(horarios.length >= 2) turno = `${horarios[0]} - ${horarios[horarios.length-1]}`;
                else if(horarios.length === 1) turno = `${horarios[0]} - 08:00`;

                if(nome !== "ND") dados.push({ obm, vtr, nome, func, horario: turno });
            }
        });

        if(dados.length > 0) {
            GM_xmlhttpRequest({
                method: "POST",
                url: URL_PONTE,
                data: JSON.stringify(dados),
                headers: { "Content-Type": "application/json" },
                onload: function(r) {
                    if(r.status === 200) { log("SUCESSO! DADOS NO PAINEL."); ultimoEnvio = agora; }
                    else log("ERRO: " + r.status);
                }
            });
        }
    }

})();

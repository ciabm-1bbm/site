from PIL import Image, ImageDraw, ImageFont, ImageFilter

def criar_arte_anjos(imagem_path, letra_musica):
    # 1. Carregar imagem original
    try:
        base_img = Image.open(imagem_path).convert("RGBA")
    except:
        return "Erro: Imagem não encontrada. Verifique o nome do arquivo."

    # 2. Configurações de Tamanho (Formato Stories/Papel de Carta Vertical)
    largura = 1080
    altura = 1920
    nova_arte = Image.new("RGBA", (largura, altura), (30, 30, 35, 255)) # Fundo cinza escuro base
    draw = ImageDraw.Draw(nova_arte)

    # 3. Processar a Imagem Original para o Fundo
    # Vamos esticar a imagem original e dar um blur para fazer um fundo texturizado
    fundo_textura = base_img.resize((largura, altura))
    fundo_textura = fundo_textura.filter(ImageFilter.GaussianBlur(30))
    nova_arte.paste(fundo_textura, (0, 0))
    
    # Adicionar uma camada escura para legibilidade
    overlay_escuro = Image.new("RGBA", (largura, altura), (0, 0, 0, 150))
    nova_arte = Image.alpha_composite(nova_arte, overlay_escuro)

    # 4. Inserir Elementos da Capa Original
    # A. Logo (Topo) - Vamos tentar recortar a parte superior da imagem original
    # Assumindo que o logo está no terço superior
    crop_logo = base_img.crop((0, 0, base_img.width, int(base_img.height * 0.35)))
    w_logo = int(largura * 0.9)
    h_logo = int(crop_logo.height * (w_logo / crop_logo.width))
    logo_resized = crop_logo.resize((w_logo, h_logo))
    
    # Criar uma máscara suave para o logo não ficar "quadrado"
    mask_logo = Image.new("L", (w_logo, h_logo), 0)
    draw_mask = ImageDraw.Draw(mask_logo)
    draw_mask.rectangle([(0, 0), (w_logo, h_logo)], fill=255)
    
    nova_arte.paste(logo_resized, (int((largura - w_logo)/2), 100), mask=logo_resized.split()[3] if 'A' in logo_resized.getbands() else None)

    # B. Banda (Rodapé) - Parte inferior da imagem
    crop_banda = base_img.crop((0, int(base_img.height * 0.35), base_img.width, base_img.height))
    w_banda = largura
    h_banda = int(crop_banda.height * (w_banda / crop_banda.width))
    banda_resized = crop_banda.resize((w_banda, h_banda))
    
    # Colar banda na parte inferior
    pos_y_banda = altura - h_banda
    nova_arte.paste(banda_resized, (0, pos_y_banda))
    
    # Fade out na parte superior da foto da banda para misturar com o fundo
    gradient = Image.new('L', (largura, 200), color=0)
    for y in range(200):
        opacity = int(255 * (y / 200))
        ImageDraw.Draw(gradient).line((0, y, largura, y), fill=opacity)
    
    # 5. Área do Texto (O "Papel de Carta")
    # Criar um retângulo central
    margem_x = 100
    margem_y_top = h_logo + 150
    margem_y_bottom = pos_y_banda - 50
    
    # Se a área for muito pequena, ajustamos
    if margem_y_bottom < margem_y_top:
        margem_y_bottom = altura - 300

    # Desenhando o título
    try:
        # Tenta usar arial se tiver, senão usa padrão
        font_titulo = ImageFont.truetype("arial.ttf", 80)
        font_letra = ImageFont.truetype("arial.ttf", 40)
        font_banda = ImageFont.truetype("arial.ttf", 30)
    except:
        font_titulo = ImageFont.load_default()
        font_letra = ImageFont.load_default()
        font_banda = ImageFont.load_default()

    draw = ImageDraw.Draw(nova_arte)
    
    # Título "Embriaguez" (Cor Laranja/Amarelo inspirada no logo)
    cor_titulo = (255, 165, 0) 
    cor_texto = (240, 240, 240)
    
    titulo = "Embriaguez"
    w_t, h_t = draw.textbbox((0, 0), titulo, font=font_titulo)[2:]
    draw.text(((largura - w_t)/2, margem_y_top), titulo, font=font_titulo, fill=cor_titulo)

    # Letra da Música
    y_text = margem_y_top + h_t + 60
    linhas = letra_musica.split('\n')
    
    for linha in linhas:
        # Pular linhas vazias com espaço menor
        if linha.strip() == "":
            y_text += 20
            continue
            
        w_l, h_l = draw.textbbox((0, 0), linha, font=font_letra)[2:]
        draw.text(((largura - w_l)/2, y_text), linha, font=font_letra, fill=cor_texto)
        y_text += h_l + 15

    # Assinatura pequena
    texto_extra = "Anjos do Hanngar - Intimidade"
    w_e, h_e = draw.textbbox((0, 0), texto_extra, font=font_banda)[2:]
    draw.text(((largura - w_e)/2, y_text + 40), texto_extra, font=font_banda, fill=(150, 150, 150))

    # 6. Salvar
    nova_arte.save("arte_embriaguez.png")
    print("Arte criada com sucesso: arte_embriaguez.png")

# Dados
letra = """Olha pra mim
Diz que não foi só um sonho meu
Aconteceu, a luz apagou
Doce embriaguez...
E o que era o acaso se perdeu
Meia-noite no meu quarto eu senti você

E amei demais
Em todos os sentidos
E o meu mundo é ficar com você!
Te amei demais
Te dei um abrigo em meu corpo,
Em meu amanhecer
Amei demais, sempre mais...
Baby, quero esse amor comigo!"""

# Executar (certifique-se de ter o arquivo cover.jpg na pasta)
criar_arte_anjos("cover.jpg", letra)

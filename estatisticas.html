<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESTAT√çSTICAS - 1¬∫ BBM (2025)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'fire-red': '#DC2626',
                        'fire-yellow': '#FFD700',
                        'bombeiros-orange': '#F97316',
                        'dark-bg': '#0f172a',
                        'cb-green': '#10B981',
                        'insect-brown': '#8B4513'
                    },
                    fontFamily: { 
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'monospace']
                    }
                }
            }
        }
    </script>

    <style>
        /* Reset e Base */
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        
        /* Background Fixo (Performance GPU) */
        .bg-fixed-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .bg-logo {
            position: absolute; top: 380px; left: 5%; right: 5%; bottom: 0;
            background: url('https://github.com/ciabm-1bbm/site/blob/main/images/brasao_1BBM_PARA_site.png?raw=true') no-repeat center top;
            background-size: contain; opacity: 0.08; filter: grayscale(100%);
        }
        .bg-gradient {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle, rgba(15,23,42,0.6) 0%, rgba(15,23,42,0.98) 100%);
        }

        /* Componentes de UI */
        .glass-panel {
            background: rgba(30, 41, 59, 0.65);
            border: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(8px);
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        /* Bot√µes */
        .btn-base { transition: all 0.2s; border: 1px solid rgba(255,255,255,0.1); }
        .btn-base:hover { background: rgba(255,255,255,0.1); border-color: #10B981; }
        .btn-base.active { 
            background: linear-gradient(45deg, #10B981, #059669); color: white; border-color: #A7F3D0; 
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.3); transform: scale(1.02);
        }
        
        .btn-anual { border-color: rgba(234, 179, 8, 0.3); color: #FEF08A; }
        .btn-anual.active {
            background: linear-gradient(45deg, #CA8A04, #EAB308); color: white;
            box-shadow: 0 0 15px rgba(234, 179, 8, 0.4);
        }

        /* Tabela Otimizada */
        .table-container { max-height: 600px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        thead th { position: sticky; top: 0; z-index: 10; background-color: #0f172a; }
        
        /* CORRE√á√ÉO CR√çTICA PARA CHART.JS NO MOBILE */
        .chart-box {
            position: relative;
            width: 100%;
            height: 300px; /* Mobile Default */
        }
        @media (min-width: 768px) {
            .chart-box { height: 550px; } /* Desktop */
        }
        
        /* Selects */
        .custom-select {
            background-color: #1e293b; color: #e2e8f0; border: 1px solid #475569;
            padding: 0.5rem; border-radius: 0.5rem; width: 100%; outline: none;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <div class="bg-fixed-layer">
        <div class="bg-logo"></div>
        <div class="bg-gradient"></div>
    </div>

    <main class="container mx-auto px-4 py-6 flex-grow z-10">
        
        <header class="flex flex-col md:flex-row items-center justify-between mb-6 gap-4 glass-panel p-6">
            <img src="https://www.bombeiros.rs.gov.br/themes/sitecbmrs/images/logos/logo.png" class="h-16 opacity-90">
            <div class="text-center">
                <h1 class="text-2xl md:text-3xl font-black text-white tracking-tighter leading-tight">ESTAT√çSTICAS DE OCORR√äNCIAS</h1>
                <h2 class="text-lg md:text-xl font-bold text-fire-yellow tracking-widest">1¬∫ BBM (2025)</h2>
                <div id="systemStatus" class="mt-2 text-xs text-gray-400 font-mono">Sistema pronto. Selecione um per√≠odo.</div>
            </div>
            <img src="https://github.com/ciabm-1bbm/site/blob/main/images/brasao_1BBM_PARA_site.png?raw=true" class="h-16 opacity-90">
        </header>

        <div id="loaderData" class="hidden mb-6 glass-panel p-4">
            <div class="flex justify-between text-xs font-mono font-bold mb-1">
                <span class="text-blue-400" id="loadText">Carregando...</span>
                <span class="text-white" id="loadPercent">0%</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-2">
                <div id="loadBar" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>

        <div class="glass-panel p-4 mb-6">
            <div class="grid grid-cols-3 md:grid-cols-6 lg:grid-cols-12 gap-2 mb-4" id="monthGrid"></div>
            <div class="flex justify-center border-t border-white/10 pt-4">
                <button id="btnAnual" class="btn-base btn-anual py-3 px-8 rounded-lg text-sm font-bold uppercase tracking-wider w-full md:w-auto">
                    ANUAL 2025
                </button>
            </div>
        </div>

        <div id="mainDashboard" class="hidden opacity-0 transition-opacity duration-500">
            
            <div class="flex justify-center mb-8">
                <div class="glass-panel border-l-4 border-emerald-500 px-8 py-4 text-center">
                    <p class="text-xs text-emerald-400 font-bold tracking-widest uppercase mb-1" id="labelTotal">TOTAL DE OCORR√äNCIAS</p>
                    <p class="text-4xl md:text-5xl font-black text-white" id="valueTotal">0</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="glass-panel p-4">
                    <h3 class="text-sm font-bold text-white mb-2 border-l-4 border-bombeiros-orange pl-3 uppercase">CONTAGEM POR PELOT√ÉO</h3>
                    <div class="chart-box">
                        <canvas id="canvasPelotoes"></canvas>
                    </div>
                </div>
                <div class="glass-panel p-4">
                    <h3 class="text-sm font-bold text-white mb-2 border-l-4 border-fire-red pl-3 uppercase">POR TIPO DE OCORR√äNCIA</h3>
                    <div class="chart-box">
                        <canvas id="canvasNatureza"></canvas>
                    </div>
                </div>
            </div>

            <div class="glass-panel p-4 mb-6">
                <h3 class="text-sm font-bold text-white mb-2 border-l-4 border-blue-500 pl-3 uppercase">DETALHAMENTO DOS SUBGRUPOS</h3>
                <div id="boxSubgrupos" class="chart-box" style="height: 500px;">
                    <canvas id="canvasSubgrupos"></canvas>
                </div>
            </div>

            <div class="glass-panel p-1 overflow-hidden">
                <div class="p-4 bg-slate-900/50 border-b border-white/10">
                    <h3 class="text-sm font-bold text-white mb-3 uppercase">Filtros de Dados</h3>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-2 text-xs">
                        <select id="selNat" class="custom-select"><option value="">Natureza</option></select>
                        <select id="selSub" class="custom-select"><option value="">Subgrupo</option></select>
                        <select id="selBai" class="custom-select"><option value="">Bairro</option></select>
                        <select id="selPel" class="custom-select"><option value="">Pelot√£o</option></select>
                        <button onclick="app.reset()" class="bg-red-600 hover:bg-red-700 text-white rounded font-bold py-2">
                            LIMPAR
                        </button>
                    </div>
                    <div class="mt-2 text-xs text-gray-400 font-mono text-right">
                        Visualizando: <span id="countVisible" class="text-white font-bold">0</span> registros
                    </div>
                </div>

                <div class="table-container">
                    <table class="w-full text-left border-collapse">
                        <thead class="text-xs text-gray-400 uppercase font-bold">
                            <tr>
                                <th class="p-3 text-center">#</th>
                                <th class="p-3">Data</th>
                                <th class="p-3">Natureza</th>
                                <th class="p-3">Subgrupo</th>
                                <th class="p-3">Bairro</th>
                                <th class="p-3">Pelot√£o</th>
                                <th class="p-3 text-center">Map</th>
                                <th class="p-3 text-right">ID</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="text-xs text-gray-300 font-mono"></tbody>
                    </table>
                </div>
            </div>

        </div> <div class="h-8"></div>
    </main>

    <footer class="w-full text-center py-6 text-gray-500 text-xs border-t border-white/5 bg-black/40">
        <p>¬© Companhia de Bombeiro Militar do 1¬∫ BBM. Desenvolvido por Gustavo Medeiros.</p>
    </footer>

    <script>
        const CONFIG = {
            repo: 'https://raw.githubusercontent.com/ciabm-1bbm/site/main',
            year: 2025,
            months: ['JAN','FEV','MAR','ABR','MAI','JUN','JUL','AGO','SET','OUT','NOV','DEZ'],
            poaPlatoons: ["A√áORIANOS", "ASSUN√á√ÉO", "TERES√ìPOLIS", "RESTINGA", "BEL√âM NOVO", "FLORESTA", "PASSO D'AREIA", "PARTENON", "AUTO RESGATE"]
        };

        const STYLES = {
            "INC√äNDIO": { color: "#FFD700", icon: "üî•", class: "text-fire-yellow" },
            "MANEJO DE INSETOS": { color: "#8B4513", icon: "üêù", class: "text-insect-brown" }, 
            "BUSCA E RESGATE": { color: "#F97316", icon: "üõü", class: "text-orange-500" },
            "CORTE DE √ÅRVORE": { color: "#4ADE80", icon: "üå≥", class: "text-green-400" },
            "A√á√ïES PREVENTIVAS": { color: "#9CA3AF", icon: "üõ°Ô∏è", class: "text-gray-400" },
            "VISTORIA DE SEGURAN√áA CONTRA INC√äNDIO": { color: "#60A5FA", icon: "üìã", class: "text-blue-400" },
            "PR√â-HOSPITALAR": { color: "#EF4444", icon: "üöë", class: "text-red-500" },
            "PRODUTOS PERIGOSOS": { color: "#FFFFFF", icon: "‚ò¢Ô∏è", class: "text-white" },
            "OUTROS": { color: "#64748B", icon: "‚ö†Ô∏è", class: "text-bombeiros-orange" }
        };

        // Estado Global da Aplica√ß√£o
        const app = {
            data: [],
            charts: {}, // Armazena inst√¢ncias dos gr√°ficos
            currentLabel: "",
            
            init: function() {
                // Registrar Plugins
                Chart.register(ChartDataLabels);
                
                // Gerar bot√µes
                const grid = document.getElementById('monthGrid');
                CONFIG.months.forEach(m => {
                    const btn = document.createElement('button');
                    btn.className = 'btn-base bg-slate-800 text-gray-300 py-3 px-1 rounded-lg text-xs font-bold uppercase tracking-wider';
                    btn.innerText = m;
                    btn.onclick = () => this.loadMonth(m);
                    grid.appendChild(btn);
                });

                document.getElementById('btnAnual').onclick = () => this.loadAnnual();

                // Listeners Filtros
                ['selNat', 'selSub', 'selBai', 'selPel'].forEach(id => {
                    document.getElementById(id).addEventListener('change', () => this.filterData());
                });
            },

            // --- CARREGAMENTO DE DADOS ---
            
            setLoading: function(show, text="", percent=0) {
                const loader = document.getElementById('loaderData');
                const dash = document.getElementById('mainDashboard');
                
                if(show) {
                    loader.classList.remove('hidden');
                    dash.classList.add('hidden');
                    dash.classList.remove('opacity-100');
                    document.getElementById('loadText').innerText = text;
                    document.getElementById('loadPercent').innerText = percent + '%';
                    document.getElementById('loadBar').style.width = percent + '%';
                } else {
                    setTimeout(() => {
                        loader.classList.add('hidden');
                        dash.classList.remove('hidden');
                        // Pequeno delay para anima√ß√£o de fade
                        requestAnimationFrame(() => dash.classList.add('opacity-100'));
                    }, 500);
                }
            },

            resetButtons: function() {
                document.querySelectorAll('button').forEach(b => {
                    b.classList.remove('active');
                    b.style.background = ''; b.style.color = ''; b.style.borderColor = '';
                });
            },

            loadMonth: async function(month) {
                this.resetButtons();
                // Achar o bot√£o clicado para ativar visualmente (opcional, simplificado aqui)
                this.setLoading(true, "Conectando...", 10);
                this.currentLabel = `EM ${month} ${CONFIG.year}`;

                try {
                    const res = await fetch(`${CONFIG.repo}/dados/${month}_${CONFIG.year}.csv`);
                    if(!res.ok) throw new Error("M√™s n√£o dispon√≠vel.");
                    
                    this.setLoading(true, "Baixando...", 50);
                    const text = await res.text();
                    
                    this.parseCSV(text);
                } catch(e) {
                    this.setLoading(false);
                    alert("Erro: " + e.message);
                }
            },

            loadAnnual: async function() {
                this.resetButtons();
                document.getElementById('btnAnual').classList.add('active');
                this.currentLabel = `NO ANO DE ${CONFIG.year}`;
                this.setLoading(true, "Iniciando compila√ß√£o...", 5);

                let combined = [];
                let processed = 0;

                const promises = CONFIG.months.map(async m => {
                    try {
                        const res = await fetch(`${CONFIG.repo}/dados/${m}_${CONFIG.year}.csv`);
                        if(res.ok) return await res.text();
                    } catch(e) {}
                    return null;
                });

                const results = await Promise.all(promises);
                
                results.forEach(csv => {
                    if(csv) {
                        const parsed = Papa.parse(csv, { header: true, skipEmptyLines: true });
                        combined = combined.concat(parsed.data);
                    }
                    processed++;
                    this.setLoading(true, "Processando...", Math.round((processed/12)*80));
                });

                this.processRows(combined);
            },

            parseCSV: function(csvText) {
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (res) => this.processRows(res.data)
                });
            },

            // --- PROCESSAMENTO DE DADOS ---

            processRows: function(rawData) {
                this.setLoading(true, "Organizando...", 90);
                this.data = []; // Limpa dados anteriores

                if(!rawData || rawData.length === 0) {
                    this.setLoading(false);
                    alert("Arquivo vazio.");
                    return;
                }

                // Detectar colunas dinamicamente
                const keys = Object.keys(rawData[0]);
                const cNat = keys.find(k => k.match(/Emerg/i) || k.match(/Natureza/i));
                const cObm = keys.find(k => k.match(/Obm/i) || k.match(/Guarni/i));
                const cSub = keys.find(k => k.match(/subgrupo/i) || k.match(/detalhe/i));
                const cVtr = keys.find(k => k.match(/Viatura/i) || k.match(/Prefixo/i));

                let idCounter = 1;

                rawData.forEach(row => {
                    const rawObm = row[cObm] ? String(row[cObm]).toUpperCase() : "";
                    const rawNat = row[cNat] ? String(row[cNat]).toUpperCase() : "N/A";
                    const rawVtr = cVtr && row[cVtr] ? String(row[cVtr]).toUpperCase() : "";
                    
                    // 1. Regras de Pelot√£o
                    let pel = "OUTROS";
                    if(rawObm.includes("MERGULHO")) pel = "BBS (POA) - MERGULHO";
                    else if(rawObm.includes("CANIL")) pel = "BBS (POA) - CANIL";
                    else if(rawObm.includes("AQUATICA") || rawObm.includes("AQU√ÅTICA")) pel = "BBS (POA) - AQU√ÅTICA";
                    else if(rawObm.includes("TERRESTRE") || (rawObm.includes("BBS") && !rawObm.includes("1¬∫"))) pel = "BBS (POA) - TERRESTRE";
                    else if(rawObm.includes("A√áORIANOS") || rawObm.includes("ACORIANOS")) pel = "A√áORIANOS";
                    else if(rawObm.includes("FLORESTA")) pel = "FLORESTA";
                    else if(rawObm.includes("PASSO")) pel = "PASSO D'AREIA";
                    else if(rawObm.includes("RESTINGA")) pel = "RESTINGA";
                    else if(rawObm.includes("PARTENON")) pel = "PARTENON";
                    else if(rawObm.includes("BEL√âM")) pel = "BEL√âM NOVO";
                    else if(rawObm.includes("ASSUN√á√ÉO") || rawObm.includes("ASSUNCAO")) pel = "ASSUN√á√ÉO";
                    else if(rawObm.includes("TERES√ìPOLIS") || rawObm.includes("TERESOPOLIS")) {
                        pel = (rawVtr.includes("AR") || rawObm.includes("RESGATE")) ? "AUTO RESGATE" : "TERES√ìPOLIS";
                    }
                    else if(rawObm.includes("RESGATE") || rawObm.includes("GBS")) pel = "AUTO RESGATE";
                    else {
                        const clean = rawObm.replace("1¬∫ BBM / ", "").replace("CIA / ", "").replace("PEL / ", "").trim();
                        if(clean.length > 2) pel = clean;
                    }

                    // 2. Regras de Natureza
                    let nat = rawNat.trim();
                    if(rawNat.includes("INSETO")) nat = "MANEJO DE INSETOS";
                    else if(rawNat.includes("INC√äNDIO") || rawNat.includes("INCENDIO")) nat = "INC√äNDIO";
                    else if(rawNat.includes("SALVAMENTO") || rawNat.includes("BUSCA")) nat = "BUSCA E RESGATE";
                    else if(rawNat.includes("√ÅRVORE") || rawNat.includes("ARVORE")) nat = "CORTE DE √ÅRVORE";
                    else if(rawNat.includes("PREVENTIVA")) nat = "A√á√ïES PREVENTIVAS";
                    else if(rawNat.includes("APH") || rawNat.includes("HOSPITALAR")) nat = "PR√â-HOSPITALAR";
                    else if(rawNat.includes("PERIGOSO") || rawNat.includes("HAZMAT")) nat = "PRODUTOS PERIGOSOS";
                    else if(rawNat.includes("VISTORIA") && rawNat.includes("INC")) nat = "VISTORIA DE SEGURAN√áA CONTRA INC√äNDIO";

                    // 3. Subgrupo
                    let sub = row[cSub] ? row[cSub].trim() : "";
                    if(sub === "N/A" || sub === "0") sub = "";

                    // 4. Mapa
                    let mapUrl = null;
                    if(row['Latitude'] && row['Longitude']) {
                        const lat = String(row['Latitude']).replace(',', '.').trim();
                        const lon = String(row['Longitude']).replace(',', '.').trim();
                        mapUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`; // Corre√ß√£o link
                    }

                    this.data.push({
                        id: row['N¬∫ Oc.'] || idCounter++,
                        data: row['Data'] || '--',
                        nat: nat,
                        sub: sub,
                        bairro: (row['Bairro'] || '--').toUpperCase(),
                        pel: pel,
                        map: mapUrl
                    });
                });

                this.populateFilters();
                this.filterData(); // Chama a renderiza√ß√£o
                this.setLoading(false);
            },

            // --- UI & RENDERIZA√á√ÉO ---

            populateFilters: function() {
                const sets = { n: new Set(), s: new Set(), b: new Set(), p: new Set() };
                this.data.forEach(d => {
                    sets.n.add(d.nat); 
                    if(d.sub) sets.s.add(d.sub);
                    if(d.bairro !== '--') sets.b.add(d.bairro);
                    sets.p.add(d.pel);
                });

                const fill = (id, set) => {
                    const el = document.getElementById(id);
                    const first = el.options[0].text;
                    el.innerHTML = `<option value="">${first}</option>`;
                    Array.from(set).sort().forEach(v => el.add(new Option(v, v)));
                };

                fill('selNat', sets.n); fill('selSub', sets.s);
                fill('selBai', sets.b); fill('selPel', sets.p);
            },

            filterData: function() {
                const filters = {
                    n: document.getElementById('selNat').value,
                    s: document.getElementById('selSub').value,
                    b: document.getElementById('selBai').value,
                    p: document.getElementById('selPel').value
                };

                const filtered = this.data.filter(d => 
                    (filters.n === "" || d.nat === filters.n) &&
                    (filters.s === "" || d.sub === filters.s) &&
                    (filters.b === "" || d.bairro === filters.b) &&
                    (filters.p === "" || d.pel === filters.p)
                );

                this.renderUI(filtered);
            },

            reset: function() {
                document.querySelectorAll('select').forEach(s => s.value = "");
                this.filterData();
            },

            renderUI: function(data) {
                // 1. Textos
                const total = data.length;
                document.getElementById('valueTotal').innerText = total.toLocaleString('pt-BR');
                document.getElementById('labelTotal').innerText = `TOTAL DE OCORR√äNCIAS ATENDIDAS ${this.currentLabel}`;
                document.getElementById('countVisible').innerText = total.toLocaleString('pt-BR');

                // 2. Tabela (Fragmento para performance)
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = ''; // Limpa r√°pido
                
                // Limite de renderiza√ß√£o na tabela para n√£o travar o celular se tiver 5000 linhas
                const renderLimit = 2000; 
                const subset = data.slice(0, renderLimit);
                
                let html = "";
                subset.forEach((d, i) => {
                    const style = STYLES[d.nat] || { icon: "üìÑ", class: "text-slate-400" };
                    const mapBtn = d.map ? `<a href="${d.map}" target="_blank" class="text-blue-400 hover:text-white"><i class="fas fa-map-marker-alt"></i></a>` : '<span class="text-gray-600"><i class="fas fa-map-marker-slash"></i></span>';
                    
                    html += `
                    <tr class="hover:bg-white/5 border-b border-gray-800/50 odd:bg-white/5">
                        <td class="p-3 text-center">${i + 1}</td>
                        <td class="p-3 whitespace-nowrap">${d.data}</td>
                        <td class="p-3 font-bold ${style.class} whitespace-nowrap"><span class="mr-2">${style.icon}</span>${d.nat}</td>
                        <td class="p-3 text-blue-200/80">${d.sub}</td>
                        <td class="p-3">${d.bairro}</td>
                        <td class="p-3"><span class="text-fire-yellow font-bold">${d.pel}</span></td>
                        <td class="p-3 text-center">${mapBtn}</td>
                        <td class="p-3 text-right text-gray-500">#${d.id}</td>
                    </tr>`;
                });
                tbody.innerHTML = html;

                // 3. Gr√°ficos (S√≥ renderiza se tiver dados)
                if(total > 0) {
                    this.prepareCharts(data);
                }
            },

            prepareCharts: function(data) {
                // Agrega√ß√£o
                const counts = { p: {}, n: {}, s: {} };
                data.forEach(d => {
                    counts.p[d.pel] = (counts.p[d.pel] || 0) + 1;
                    counts.n[d.nat] = (counts.n[d.nat] || 0) + 1;
                    if(d.sub) counts.s[`${d.nat}___${d.sub}`] = (counts.s[`${d.nat}___${d.sub}`] || 0) + 1;
                });

                // Ordena√ß√£o e Arrays
                const sort = (o) => Object.entries(o).sort((a,b) => b[1] - a[1]);
                
                const pData = sort(counts.p);
                const nData = sort(counts.n);
                const sData = sort(counts.s).filter(x => x[1] >= 1); // Filtro >= 1

                this.renderChart('canvasPelotoes', 'p', pData);
                this.renderChart('canvasNatureza', 'n', nData);
                this.renderChart('canvasSubgrupos', 's', sData);
            },

            renderChart: function(canvasId, type, dataset) {
                // Destruir anterior se existir
                if (this.charts[canvasId]) {
                    this.charts[canvasId].destroy();
                }

                // Configurar Labels e Cores Espec√≠ficas
                const labels = dataset.map(x => {
                    if (type === 'p') return x[0];
                    if (type === 'n') {
                        const style = STYLES[x[0]] || { icon: "üìÑ" };
                        // Quebra de linha para Vistoria
                        if (x[0].includes("VISTORIA")) return [`${style.icon} VISTORIA DE SEGURAN√áA`, "CONTRA INC√äNDIO"];
                        return `${style.icon} ${x[0]}`;
                    }
                    if (type === 's') {
                        const [nat, sub] = x[0].split('___');
                        const style = STYLES[nat] || { icon: "üìÑ" };
                        return `${style.icon} ${nat} [${sub}]`;
                    }
                });

                const values = dataset.map(x => x[1]);

                // Contexto do Canvas
                const ctx = document.getElementById(canvasId).getContext('2d');

                // Ajuste de altura din√¢mica para o gr√°fico de subgrupos
                if (type === 's') {
                    const container = document.getElementById('boxSubgrupos');
                    const newHeight = Math.max(500, values.length * 25);
                    container.style.height = `${newHeight}px`;
                }

                // Configura√ß√£o Chart.js v4
                this.charts[canvasId] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            borderRadius: 4,
                            barPercentage: 0.7,
                            // COR DAS BARRAS
                            backgroundColor: (context) => {
                                if (type === 'p') {
                                    // Verde para POA, Cinza para outros
                                    return CONFIG.poaPlatoons.includes(dataset[context.dataIndex][0]) ? '#10B981' : '#475569';
                                }
                                if (type === 'n') {
                                    const label = dataset[context.dataIndex][0];
                                    return (STYLES[label] || { color: "#94A3B8" }).color;
                                }
                                if (type === 's') {
                                    const nat = dataset[context.dataIndex][0].split('___')[0];
                                    return (STYLES[nat] || { color: "#94A3B8" }).color;
                                }
                                return '#3B82F6';
                            }
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: false, // Performance
                        layout: { padding: { right: 50 } },
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                color: '#fff', anchor: 'end', align: 'end', offset: 4,
                                font: { weight: 'bold' },
                                formatter: (val) => val.toLocaleString('pt-BR')
                            },
                            tooltip: { enabled: true, backgroundColor: 'rgba(0,0,0,0.8)' }
                        },
                        scales: {
                            x: { display: false }, // Remove grid X
                            y: {
                                border: { display: false },
                                grid: { color: 'rgba(255,255,255,0.05)' },
                                ticks: {
                                    // COR DA FONTE DO EIXO Y
                                    color: (context) => {
                                        if (type === 'p') {
                                            const label = dataset[context.index][0];
                                            return CONFIG.poaPlatoons.includes(label) ? '#10B981' : '#94A3B8';
                                        }
                                        if (type === 'n') {
                                            const label = dataset[context.index][0];
                                            return (STYLES[label] || { color: "#94A3B8" }).color;
                                        }
                                        if (type === 's') {
                                            const nat = dataset[context.index][0].split('___')[0];
                                            return (STYLES[nat] || { color: "#94A3B8" }).color;
                                        }
                                        return '#cbd5e1';
                                    },
                                    // TAMANHO DA FONTE
                                    font: (context) => {
                                        let size = 11;
                                        let weight = 'normal';
                                        if (type === 'p') {
                                            const label = dataset[context.index][0];
                                            if (CONFIG.poaPlatoons.includes(label)) {
                                                size = 14; weight = 'bold';
                                            }
                                        }
                                        return { size: size, weight: weight, family: 'monospace' };
                                    },
                                    autoSkip: false
                                }
                            }
                        }
                    }
                });
            }
        };

        // Iniciar
        document.addEventListener('DOMContentLoaded', () => app.init());

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estatísticas 1º BBM - 2025</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'fire-red': '#DC2626',
                        'fire-yellow': '#FFD700',
                        'bombeiros-orange': '#F97316',
                        'dark-bg': '#0f172a'
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body { background-color: #0f172a; color: white; font-family: 'Inter', sans-serif; }
        
        .hero-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .hero-bg::before {
            content: ''; position: absolute; top: 20%; left: 10%; right: 10%; bottom: 0;
            background: url('https://github.com/ciabm-1bbm/site/blob/main/images/brasao_1BBM_PARA_site.png?raw=true') no-repeat center top;
            background-size: contain; opacity: 0.1; filter: grayscale(100%);
        }
        .hero-bg::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle, rgba(15,23,42,0.4) 0%, rgba(15,23,42,0.9) 100%);
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        /* Botões de Mês */
        .btn-mes {
            transition: all 0.2s;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .btn-mes:hover { background: rgba(255,255,255,0.1); border-color: #F97316; }
        .btn-mes.active { 
            background: linear-gradient(45deg, #DC2626, #B91C1C); 
            color: white; 
            border-color: #FFD700;
            box-shadow: 0 0 10px rgba(220, 38, 38, 0.5);
        }

        /* Scrollbar Tabela */
        .table-scroll { max-height: 500px; overflow-y: auto; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        thead th { position: sticky; top: 0; z-index: 10; background-color: rgba(15, 23, 42, 0.95); }
    </style>
</head>
<body class="min-h-screen">

    <div class="hero-bg"></div>

    <div class="container mx-auto px-4 py-8 relative z-10">
        
        <header class="flex flex-col md:flex-row items-center justify-between mb-8 gap-6 glass-card p-6">
            <img src="https://www.bombeiros.rs.gov.br/themes/sitecbmrs/images/logos/logo.png" class="h-20 drop-shadow-lg opacity-90">
            
            <div class="text-center flex-1">
                <h1 class="text-3xl font-black uppercase tracking-tighter text-white mb-2 leading-none">
                    Estatísticas de Atendimento
                </h1>
                <h2 class="text-xl font-bold text-fire-yellow tracking-widest uppercase">
                    1º BBM (<span id="anoTitulo">2025</span>)
                </h2>
                <div class="mt-2 text-sm text-gray-400" id="statusMsg">Selecione um mês para carregar os dados</div>
            </div>

            <img src="https://github.com/ciabm-1bbm/site/blob/main/images/brasao_1BBM_PARA_site.png?raw=true" class="h-20 drop-shadow-lg opacity-90">
        </header>

        <div class="glass-card p-4 mb-8">
            <div class="grid grid-cols-3 md:grid-cols-6 lg:grid-cols-12 gap-2" id="mesesContainer">
                </div>
        </div>

        <div id="dashboardArea" class="opacity-50 pointer-events-none transition-opacity duration-500">
            
            <div class="flex justify-center mb-8">
                <div class="bg-blue-600/20 border border-blue-500 text-blue-300 px-8 py-4 rounded-2xl text-center shadow-lg backdrop-blur-md">
                    <p class="text-sm uppercase font-bold tracking-widest mb-1">Total de Ocorrências</p>
                    <p class="text-5xl font-black text-white" id="totalDisplay">0</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="glass-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 border-l-4 border-bombeiros-orange pl-3 uppercase">Por Subunidade</h3>
                    <div class="relative h-72"><canvas id="chartPelotoes"></canvas></div>
                </div>
                <div class="glass-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 border-l-4 border-fire-red pl-3 uppercase">Por Natureza</h3>
                    <div class="relative h-72"><canvas id="chartNatureza"></canvas></div>
                </div>
            </div>

            <div class="glass-card p-1 overflow-hidden">
                <div class="p-4 border-b border-white/10 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-white border-l-4 border-blue-500 pl-3 uppercase">Detalhamento</h3>
                    <span class="text-xs text-gray-400">Total listado: <span id="totalLista">0</span></span>
                </div>
                <div class="table-scroll">
                    <table class="w-full text-left border-collapse">
                        <thead class="text-xs text-gray-300 uppercase font-bold">
                            <tr>
                                <th class="p-3 text-center w-12">#</th>
                                <th class="p-3">Data</th>
                                <th class="p-3">Natureza</th>
                                <th class="p-3">Bairro</th>
                                <th class="p-3">Viatura</th>
                                <th class="p-3 text-center">Local</th>
                                <th class="p-3 text-right">ID</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaBody" class="text-sm text-gray-200 font-mono"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ================= CONFIGURAÇÕES =================
        // URL PADRÃO MAIS SEGURA (SEM O REFS/HEADS)
        const GITHUB_BASE_URL = 'https://raw.githubusercontent.com/ciabm-1bbm/site/main'; 
        const ANO_ATUAL = 2025;
        
        // Cores para os gráficos
        const colorsPalette = [
            '#EF4444', '#F97316', '#F59E0B', '#10B981', '#06B6D4', '#3B82F6', 
            '#6366F1', '#8B5CF6', '#EC4899', '#F43F5E', '#64748B', '#A8A29E'
        ];

        let chartP = null;
        let chartN = null;

        // ================= INICIALIZAÇÃO =================
        const meses = [
            { id: 'JAN', nome: 'Janeiro' }, { id: 'FEV', nome: 'Fevereiro' },
            { id: 'MAR', nome: 'Março' }, { id: 'ABR', nome: 'Abril' },
            { id: 'MAI', nome: 'Maio' }, { id: 'JUN', nome: 'Junho' },
            { id: 'JUL', nome: 'Julho' }, { id: 'AGO', nome: 'Agosto' },
            { id: 'SET', nome: 'Setembro' }, { id: 'OUT', nome: 'Outubro' },
            { id: 'NOV', nome: 'Novembro' }, { id: 'DEZ', nome: 'Dezembro' }
        ];

        window.onload = () => {
            gerarBotoes();
        };

        function gerarBotoes() {
            const container = document.getElementById('mesesContainer');
            meses.forEach(m => {
                const btn = document.createElement('button');
                btn.className = 'btn-mes bg-slate-800 text-gray-300 py-2 px-1 rounded-lg text-xs font-bold uppercase tracking-wider';
                btn.innerText = m.id;
                btn.onclick = () => carregarDados(m.id, btn);
                container.appendChild(btn);
            });
        }

        // ================= CARREGAMENTO DE DADOS =================
        async function carregarDados(mes, btnElement) {
            // UI Feedback
            document.querySelectorAll('.btn-mes').forEach(b => b.classList.remove('active'));
            if(btnElement) btnElement.classList.add('active');
            
            const msg = document.getElementById('statusMsg');
            msg.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Buscando dados de ${mes}/${ANO_ATUAL}...`;
            msg.className = "mt-2 text-sm text-yellow-400";

            // Montagem da URL
            const url = `${GITHUB_BASE_URL}/dados/${mes}_${ANO_ATUAL}.csv`;
            console.log("Tentando baixar:", url);

            try {
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP ${response.status}: Arquivo não encontrado no GitHub.`);
                }

                const csvText = await response.text(); // Pega o texto puro
                
                // Parse CSV com Detecção Automática de Separador (Vírgula ou Ponto e Vírgula)
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    encoding: "UTF-8", // Tenta forçar UTF-8
                    complete: function(results) {
                        if (results.data && results.data.length > 0) {
                            try {
                                processarDados(results.data);
                                msg.innerHTML = `<i class="fas fa-check"></i> Dados de ${mes} carregados com sucesso.`;
                                msg.className = "mt-2 text-sm text-green-400";
                                document.getElementById('dashboardArea').classList.remove('opacity-50', 'pointer-events-none');
                            } catch (e) {
                                console.error(e);
                                alert("Erro ao processar planilha: " + e.message);
                                msg.innerHTML = "Erro no processamento dos dados.";
                            }
                        } else {
                            alert("O arquivo foi encontrado, mas parece estar vazio.");
                        }
                    }
                });

            } catch (error) {
                console.error(error);
                msg.innerHTML = `<i class="fas fa-times-circle"></i> Erro: ${error.message}`;
                msg.className = "mt-2 text-sm text-red-400";
                document.getElementById('dashboardArea').classList.add('opacity-50', 'pointer-events-none');
            }
        }

        // ================= PROCESSAMENTO =================
        function processarDados(data) {
            // --- TRATAMENTO DE ACENTUAÇÃO ---
            // Às vezes o Excel exporta "Emergência" como "Emergencia" ou caracteres estranhos.
            // Vamos procurar qual é a chave correta.
            const chaves = Object.keys(data[0]);
            
            // Procura a coluna de Natureza (Emergência)
            const colNat = chaves.find(k => k.includes("Emerg") || k.includes("EMERG") || k.includes("Natureza"));
            // Procura a coluna de OBM
            const colObm = chaves.find(k => k.includes("Obm") || k.includes("OBM") || k.includes("Guarni"));

            if (!colNat || !colObm) {
                throw new Error(`Colunas não encontradas!\nO sistema procurou por 'Emergência' e 'Obm.'\nColunas encontradas no arquivo: ${chaves.join(", ")}`);
            }

            const countPelotao = {};
            const countNatureza = {};
            const lista = [];
            let total = 0;

            const mapearPelotao = (obmRaw) => {
                const s = obmRaw ? String(obmRaw).toUpperCase() : "";
                if(s.includes("AÇORIANOS") || s.includes("ACORIANOS")) return "1ª Cia Açorianos";
                if(s.includes("FLORESTA")) return "2ª Cia Floresta";
                if(s.includes("PASSO")) return "2ª Cia Passo D'Areia";
                if(s.includes("RESTINGA")) return "1ª Cia Restinga";
                if(s.includes("TERESÓPOLIS") || s.includes("TERESOPOLIS")) return "1ª Cia Teresópolis";
                if(s.includes("PARTENON")) return "2ª Cia Partenon";
                if(s.includes("BELÉM") || s.includes("BELEM")) return "1ª Cia Belém Novo";
                if(s.includes("ASSUNÇÃO") || s.includes("ASSUNCAO")) return "1ª Cia Assunção";
                return "Outros";
            };

            data.forEach(row => {
                total++;
                
                // Pega o valor usando a coluna que encontramos dinamicamente
                const obmValor = row[colObm];
                const natValor = row[colNat];
                const dataValor = row['Data'] || row['DATA'] || '---';
                const bairroValor = row['Bairro'] || row['BAIRRO'] || '---';
                const vtrValor = row['Viaturas'] || row['VIATURAS'] || '---';
                
                // Contagem Pelotão
                const pel = mapearPelotao(obmValor);
                countPelotao[pel] = (countPelotao[pel] || 0) + 1;

                // Contagem Natureza
                let nat = natValor ? String(natValor).toUpperCase() : "OUTROS";
                if(nat.includes("INSETO")) nat = "Manejo de Insetos";
                else if(nat.includes("INCÊNDIO") || nat.includes("INCENDIO")) nat = "Incêndio";
                else if(nat.includes("SALVAMENTO") || nat.includes("BUSCA")) nat = "Busca e Resgate";
                else if(nat.includes("ÁRVORE") || nat.includes("ARVORE")) nat = "Corte de Árvore";
                else if(nat.includes("PREVENTIVA")) nat = "Ações Preventivas";
                
                countNatureza[nat] = (countNatureza[nat] || 0) + 1;

                // Lista
                lista.push({
                    id: row['Nº Oc.'] || row['ID'] || total,
                    data: dataValor,
                    nat: natValor,
                    bairro: bairroValor,
                    vtr: vtrValor,
                    lat: row['Latitude'] || row['LATITUDE'],
                    lon: row['Longitude'] || row['LONGITUDE']
                });
            });

            const sortedPelotao = Object.entries(countPelotao).sort((a,b) => b[1] - a[1]);
            const sortedNatureza = Object.entries(countNatureza).sort((a,b) => b[1] - a[1]);

            atualizarDashboard({
                total: total,
                pelotoes: { labels: sortedPelotao.map(x=>x[0]), data: sortedPelotao.map(x=>x[1]) },
                natureza: { labels: sortedNatureza.map(x=>x[0]), data: sortedNatureza.map(x=>x[1]) },
                lista: lista
            });
        }

        // ================= ATUALIZAÇÃO UI =================
        function atualizarDashboard(dados) {
            document.getElementById('totalDisplay').innerText = dados.total;
            document.getElementById('totalLista').innerText = dados.total;

            Chart.defaults.color = '#94a3b8';
            Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';

            if(chartP) chartP.destroy();
            chartP = new Chart(document.getElementById('chartPelotoes'), {
                type: 'bar',
                data: {
                    labels: dados.pelotoes.labels,
                    datasets: [{
                        label: 'Ocorrências',
                        data: dados.pelotoes.data,
                        backgroundColor: colorsPalette,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            if(chartN) chartN.destroy();
            chartN = new Chart(document.getElementById('chartNatureza'), {
                type: 'bar',
                data: {
                    labels: dados.natureza.labels,
                    datasets: [{
                        label: 'Ocorrências',
                        data: dados.natureza.data,
                        backgroundColor: colorsPalette,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            renderTable(dados.lista);
        }

        function renderTable(lista) {
            const tbody = document.getElementById('tabelaBody');
            tbody.innerHTML = '';

            lista.forEach((oc, index) => {
                let cor = 'text-white';
                let icon = 'fa-bell';
                let tipo = oc.nat ? String(oc.nat).toUpperCase() : "OUTROS";

                if(tipo.includes('INCÊNDIO') || tipo.includes('INCENDIO')) { cor = 'text-fire-yellow'; icon = 'fa-fire'; }
                else if(tipo.includes('PREVENTIVA') || tipo.includes('VISTORIA')) { cor = 'text-gray-400'; icon = 'fa-shield-alt'; }
                else if(tipo.includes('ÁRVORE') || tipo.includes('ARVORE')) { cor = 'text-green-400'; icon = 'fa-tree'; }
                else if(tipo.includes('INSETO')) { cor = 'text-yellow-200'; icon = 'fa-bug'; }
                else if(tipo.includes('APH') || tipo.includes('HOSPITALAR')) { cor = 'text-red-500'; icon = 'fa-ambulance'; }
                else { cor = 'text-bombeiros-orange'; icon = 'fa-exclamation-triangle'; }

                let mapsLink = '';
                if(oc.lat && oc.lon) {
                    const lat = String(oc.lat).replace(',', '.');
                    const lon = String(oc.lon).replace(',', '.');
                    const urlMap = `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;
                    mapsLink = `<a href="${urlMap}" target="_blank" class="text-blue-400 hover:text-white transition-colors"><i class="fas fa-map-marker-alt fa-lg"></i></a>`;
                } else {
                    mapsLink = `<span class="text-gray-600 cursor-not-allowed"><i class="fas fa-map-marker-slash"></i></span>`;
                }

                const tr = `
                    <tr class="hover:bg-white/5 transition-colors border-b border-white/5 odd:bg-white/5 even:bg-transparent">
                        <td class="p-3 text-center font-bold text-gray-500 text-xs">${index + 1}</td>
                        <td class="p-3 font-mono opacity-80 whitespace-nowrap text-xs">${oc.data}</td>
                        <td class="p-3 font-bold ${cor} text-xs"><i class="fas ${icon} w-4 text-center"></i> ${oc.nat}</td>
                        <td class="p-3 uppercase text-xs tracking-wider text-gray-300">${oc.bairro}</td>
                        <td class="p-3"><span class="bg-slate-700 text-white px-2 py-1 rounded text-xs font-mono border border-white/10">${oc.vtr}</span></td>
                        <td class="p-3 text-center">${mapsLink}</td>
                        <td class="p-3 text-right font-mono opacity-50 text-xs">#${oc.id}</td>
                    </tr>
                `;
                tbody.innerHTML += tr;
            });
        }
    </script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estatísticas 1º BBM - Porto Alegre</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'fire-red': '#DC2626',
                        'fire-yellow': '#FFD700',
                        'bombeiros-orange': '#F97316',
                        'dark-bg': '#0f172a',
                        'cb-green': '#10B981'
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body { background-color: #0f172a; color: white; font-family: 'Inter', sans-serif; }
        
        .hero-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .hero-bg::before {
            content: ''; position: absolute; top: 20%; left: 10%; right: 10%; bottom: 0;
            background: url('https://github.com/ciabm-1bbm/site/blob/main/images/brasao_1BBM_PARA_site.png?raw=true') no-repeat center top;
            background-size: contain; opacity: 0.1; filter: grayscale(100%);
        }
        .hero-bg::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle, rgba(15,23,42,0.4) 0%, rgba(15,23,42,0.9) 100%);
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        /* Botões de Mês - VERDE quando ativo */
        .btn-mes {
            transition: all 0.2s;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .btn-mes:hover { background: rgba(255,255,255,0.1); border-color: #10B981; }
        
        .btn-mes.active { 
            background: linear-gradient(45deg, #10B981, #059669);
            color: white; 
            border-color: #A7F3D0;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.4);
            transform: scale(1.05);
        }

        /* Scrollbar Tabela */
        .table-scroll { max-height: 500px; overflow-y: auto; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        thead th { position: sticky; top: 0; z-index: 10; background-color: rgba(15, 23, 42, 0.95); }
    </style>
</head>
<body class="min-h-screen">

    <div class="hero-bg"></div>

    <div class="container mx-auto px-4 py-8 relative z-10">
        
        <header class="flex flex-col md:flex-row items-center justify-between mb-8 gap-6 glass-card p-6">
            <img src="https://www.bombeiros.rs.gov.br/themes/sitecbmrs/images/logos/logo.png" class="h-20 drop-shadow-lg opacity-90">
            
            <div class="text-center flex-1">
                <h1 class="text-3xl font-black uppercase tracking-tighter text-white mb-2 leading-none">
                    Estatísticas de Ocorrências
                </h1>
                <h2 class="text-xl font-bold text-fire-yellow tracking-widest uppercase">
                    1º BBM - PORTO ALEGRE (<span id="anoTitulo">2025</span>)
                </h2>
                <div class="mt-2 text-sm text-gray-400" id="statusMsg">Selecione um mês para carregar os dados</div>
            </div>

            <img src="https://github.com/ciabm-1bbm/site/blob/main/images/brasao_1BBM_PARA_site.png?raw=true" class="h-20 drop-shadow-lg opacity-90">
        </header>

        <div class="glass-card p-4 mb-8">
            <div class="grid grid-cols-3 md:grid-cols-6 lg:grid-cols-12 gap-2" id="mesesContainer">
                </div>
        </div>

        <div id="dashboardArea" class="opacity-50 pointer-events-none transition-opacity duration-500">
            
            <div class="flex justify-center mb-8">
                <div class="bg-emerald-600/20 border border-emerald-500 text-emerald-300 px-8 py-4 rounded-2xl text-center shadow-lg backdrop-blur-md">
                    <p class="text-sm uppercase font-bold tracking-widest mb-1">Total de Ocorrências</p>
                    <p class="text-5xl font-black text-white" id="totalDisplay">0</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="glass-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 border-l-4 border-bombeiros-orange pl-3 uppercase">Por Subunidade</h3>
                    <div class="relative h-[350px]"><canvas id="chartPelotoes"></canvas></div>
                </div>
                <div class="glass-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 border-l-4 border-fire-red pl-3 uppercase">Por Natureza</h3>
                    <div class="relative h-[350px]"><canvas id="chartNatureza"></canvas></div>
                </div>
            </div>

            <div class="glass-card p-6 mb-8">
                <h3 class="text-lg font-bold text-white mb-4 border-l-4 border-blue-500 pl-3 uppercase">Principais Subgrupos (Top 15)</h3>
                <div class="relative h-[350px]"><canvas id="chartSubgrupos"></canvas></div>
            </div>

            <div class="glass-card p-1 overflow-hidden">
                <div class="p-4 border-b border-white/10 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-white border-l-4 border-blue-500 pl-3 uppercase">Detalhamento</h3>
                    <span class="text-xs text-gray-400">Total listado: <span id="totalLista">0</span></span>
                </div>
                <div class="table-scroll">
                    <table class="w-full text-left border-collapse">
                        <thead class="text-xs text-gray-300 uppercase font-bold">
                            <tr>
                                <th class="p-3 text-center w-12">#</th>
                                <th class="p-3">Data</th>
                                <th class="p-3">Natureza</th>
                                <th class="p-3">Subgrupo</th> <th class="p-3">Bairro</th>
                                <th class="p-3">Viatura</th>
                                <th class="p-3 text-center">Local</th>
                                <th class="p-3 text-right">ID</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaBody" class="text-sm text-gray-200 font-mono"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ================= CONFIGURAÇÕES =================
        const GITHUB_BASE_URL = 'https://raw.githubusercontent.com/ciabm-1bbm/site/main'; 
        const ANO_ATUAL = 2025;
        
        const colorsPalette = [
            '#EF4444', '#F97316', '#F59E0B', '#10B981', '#06B6D4', '#3B82F6', 
            '#6366F1', '#8B5CF6', '#EC4899', '#F43F5E', '#64748B', '#A8A29E'
        ];

        let chartP = null;
        let chartN = null;
        let chartS = null; // Chart Subgrupos

        // ================= INICIALIZAÇÃO =================
        const meses = [
            { id: 'JAN', nome: 'Janeiro' }, { id: 'FEV', nome: 'Fevereiro' },
            { id: 'MAR', nome: 'Março' }, { id: 'ABR', nome: 'Abril' },
            { id: 'MAI', nome: 'Maio' }, { id: 'JUN', nome: 'Junho' },
            { id: 'JUL', nome: 'Julho' }, { id: 'AGO', nome: 'Agosto' },
            { id: 'SET', nome: 'Setembro' }, { id: 'OUT', nome: 'Outubro' },
            { id: 'NOV', nome: 'Novembro' }, { id: 'DEZ', nome: 'Dezembro' }
        ];

        window.onload = () => {
            gerarBotoes();
        };

        function gerarBotoes() {
            const container = document.getElementById('mesesContainer');
            meses.forEach(m => {
                const btn = document.createElement('button');
                btn.className = 'btn-mes bg-slate-800 text-gray-300 py-2 px-1 rounded-lg text-xs font-bold uppercase tracking-wider';
                btn.innerText = m.id;
                btn.onclick = () => carregarDados(m.id, btn);
                container.appendChild(btn);
            });
        }

        async function carregarDados(mes, btnElement) {
            document.querySelectorAll('.btn-mes').forEach(b => b.classList.remove('active'));
            if(btnElement) btnElement.classList.add('active');
            
            const msg = document.getElementById('statusMsg');
            msg.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Buscando dados de ${mes}/${ANO_ATUAL}...`;
            msg.className = "mt-2 text-sm text-yellow-400";

            const url = `${GITHUB_BASE_URL}/dados/${mes}_${ANO_ATUAL}.csv`;
            console.log("Baixando:", url);

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Erro HTTP ${response.status}`);
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    encoding: "UTF-8",
                    complete: function(results) {
                        if (results.data && results.data.length > 0) {
                            try {
                                processarDados(results.data);
                                msg.innerHTML = `<i class="fas fa-check"></i> Dados de ${mes} carregados com sucesso.`;
                                msg.className = "mt-2 text-sm text-green-400";
                                document.getElementById('dashboardArea').classList.remove('opacity-50', 'pointer-events-none');
                            } catch (e) {
                                console.error(e);
                                alert("Erro processando dados: " + e.message);
                            }
                        } else {
                            alert("Arquivo vazio.");
                        }
                    }
                });

            } catch (error) {
                console.error(error);
                msg.innerHTML = `<i class="fas fa-times-circle"></i> Erro: ${error.message}`;
                msg.className = "mt-2 text-sm text-red-400";
                document.getElementById('dashboardArea').classList.add('opacity-50', 'pointer-events-none');
            }
        }

        function processarDados(data) {
            const chaves = Object.keys(data[0]);
            
            // Busca dinâmica de colunas
            const colNat = chaves.find(k => k.match(/Emerg/i) || k.match(/Natureza/i));
            const colObm = chaves.find(k => k.match(/Obm/i) || k.match(/Guarni/i));
            // Procura coluna de Subgrupo (todos_subgrupos ou Subgrupo)
            const colSub = chaves.find(k => k.match(/subgrupo/i) || k.match(/detalhe/i) || k.match(/tipo/i));

            if (!colNat || !colObm) {
                throw new Error("Colunas obrigatórias (Emergência/OBM) não encontradas.");
            }

            const countPelotao = {};
            const countNatureza = {};
            const countSubgrupo = {};
            const lista = [];
            let total = 0;

            const mapearPelotao = (obmRaw) => {
                const s = obmRaw ? String(obmRaw).toUpperCase() : "";
                if(s.includes("AÇORIANOS") || s.includes("ACORIANOS")) return "AÇORIANOS";
                if(s.includes("FLORESTA")) return "FLORESTA";
                if(s.includes("PASSO")) return "PASSO D'AREIA";
                if(s.includes("RESTINGA")) return "RESTINGA";
                if(s.includes("TERESÓPOLIS") || s.includes("TERESOPOLIS")) return "TERESÓPOLIS";
                if(s.includes("PARTENON")) return "PARTENON";
                if(s.includes("BELÉM") || s.includes("BELEM")) return "BELÉM NOVO";
                if(s.includes("ASSUNÇÃO") || s.includes("ASSUNCAO")) return "ASSUNÇÃO";
                if(s.includes("RESGATE") || s.includes("GBS")) return "AUTO RESGATE";
                return "OUTROS";
            };

            data.forEach(row => {
                total++;
                
                // Extração dos valores
                const obmValor = row[colObm];
                const natValor = row[colNat];
                // Subgrupo: Se não tiver a coluna, deixa vazio
                let subValor = colSub ? (row[colSub] || "N/A") : "N/A";
                
                // Contagem Pelotão
                const pel = mapearPelotao(obmValor);
                countPelotao[pel] = (countPelotao[pel] || 0) + 1;

                // Contagem Natureza
                let nat = natValor ? String(natValor).toUpperCase() : "OUTROS";
                if(nat.includes("INSETO")) nat = "MANEJO DE INSETOS";
                else if(nat.includes("INCÊNDIO") || nat.includes("INCENDIO")) nat = "INCÊNDIO";
                else if(nat.includes("SALVAMENTO") || nat.includes("BUSCA")) nat = "BUSCA E RESGATE";
                else if(nat.includes("ÁRVORE") || nat.includes("ARVORE")) nat = "CORTE DE ÁRVORE";
                else if(nat.includes("PREVENTIVA")) nat = "AÇÕES PREVENTIVAS";
                else if(nat.includes("APH") || nat.includes("HOSPITALAR")) nat = "PRÉ-HOSPITALAR";
                
                countNatureza[nat] = (countNatureza[nat] || 0) + 1;

                // Contagem Subgrupo (Ignora N/A e vazios para o gráfico)
                if (subValor && subValor !== "N/A" && subValor.trim() !== "") {
                    // Limpeza básica do texto
                    let subClean = String(subValor).toUpperCase().trim();
                    countSubgrupo[subClean] = (countSubgrupo[subClean] || 0) + 1;
                }

                lista.push({
                    id: row['Nº Oc.'] || row['ID'] || total,
                    data: row['Data'] || row['DATA'] || '---',
                    nat: natValor,
                    sub: subValor, // Armazena para a tabela
                    bairro: row['Bairro'] || row['BAIRRO'] || '---',
                    vtr: mapearPelotao(obmValor),
                    lat: row['Latitude'] || row['LATITUDE'],
                    lon: row['Longitude'] || row['LONGITUDE']
                });
            });

            // Ordenações
            const sortedPelotao = Object.entries(countPelotao).sort((a,b) => b[1] - a[1]);
            const sortedNatureza = Object.entries(countNatureza).sort((a,b) => b[1] - a[1]);
            
            // Top 15 Subgrupos (para o gráfico não ficar gigante)
            const sortedSubgrupo = Object.entries(countSubgrupo)
                .sort((a,b) => b[1] - a[1])
                .slice(0, 15);

            atualizarDashboard({
                total: total,
                pelotoes: { labels: sortedPelotao.map(x=>x[0]), data: sortedPelotao.map(x=>x[1]) },
                natureza: { labels: sortedNatureza.map(x=>x[0]), data: sortedNatureza.map(x=>x[1]) },
                subgrupos: { labels: sortedSubgrupo.map(x=>x[0]), data: sortedSubgrupo.map(x=>x[1]) },
                lista: lista
            });
        }

        function atualizarDashboard(dados) {
            document.getElementById('totalDisplay').innerText = dados.total;
            document.getElementById('totalLista').innerText = dados.total;

            Chart.defaults.color = '#e2e8f0';
            Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';
            Chart.defaults.font.family = 'Inter';

            const commonOptions = {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        titleFont: { size: 14, weight: 'bold' },
                        bodyFont: { size: 13 },
                        padding: 10,
                        backgroundColor: 'rgba(15, 23, 42, 0.95)',
                        borderColor: 'rgba(255,255,255,0.1)',
                        borderWidth: 1

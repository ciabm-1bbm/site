<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EstatÃ­sticas 1Âº BBM - Porto Alegre</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'fire-red': '#DC2626',
                        'fire-yellow': '#FFD700',
                        'bombeiros-orange': '#F97316',
                        'dark-bg': '#0f172a',
                        'cb-green': '#10B981'
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body { background-color: #0f172a; color: white; font-family: 'Inter', sans-serif; }
        
        .hero-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .hero-bg::before {
            content: ''; position: absolute; top: 20%; left: 10%; right: 10%; bottom: 0;
            background: url('https://github.com/ciabm-1bbm/site/blob/main/images/brasao_1BBM_PARA_site.png?raw=true') no-repeat center top;
            background-size: contain; opacity: 0.1; filter: grayscale(100%);
        }
        .hero-bg::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle, rgba(15,23,42,0.4) 0%, rgba(15,23,42,0.9) 100%);
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        /* BotÃµes de MÃªs - VERDE quando ativo */
        .btn-mes {
            transition: all 0.2s;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .btn-mes:hover { background: rgba(255,255,255,0.1); border-color: #10B981; }
        
        .btn-mes.active { 
            background: linear-gradient(45deg, #10B981, #059669);
            color: white; 
            border-color: #A7F3D0;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.4);
            transform: scale(1.05);
        }

        /* Scrollbar Tabela */
        .table-scroll { max-height: 500px; overflow-y: auto; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        thead th { position: sticky; top: 0; z-index: 10; background-color: rgba(15, 23, 42, 0.95); }
    </style>
</head>
<body class="min-h-screen">

    <div class="hero-bg"></div>

    <div class="container mx-auto px-4 py-8 relative z-10">
        
        <header class="flex flex-col md:flex-row items-center justify-between mb-8 gap-6 glass-card p-6">
            <img src="https://www.bombeiros.rs.gov.br/themes/sitecbmrs/images/logos/logo.png" class="h-20 drop-shadow-lg opacity-90">
            
            <div class="text-center flex-1">
                <h1 class="text-3xl font-black uppercase tracking-tighter text-white mb-2 leading-none">
                    EstatÃ­sticas de OcorrÃªncias
                </h1>
                <h2 class="text-xl font-bold text-fire-yellow tracking-widest uppercase">
                    1Âº BBM - PORTO ALEGRE (<span id="anoTitulo">2025</span>)
                </h2>
                <div class="mt-2 text-sm text-gray-400" id="statusMsg">Selecione um mÃªs para carregar os dados</div>
            </div>

            <img src="https://github.com/ciabm-1bbm/site/blob/main/images/brasao_1BBM_PARA_site.png?raw=true" class="h-20 drop-shadow-lg opacity-90">
        </header>

        <div class="glass-card p-4 mb-8">
            <div class="grid grid-cols-3 md:grid-cols-6 lg:grid-cols-12 gap-2" id="mesesContainer"></div>
        </div>

        <div id="dashboardArea" class="opacity-50 pointer-events-none transition-opacity duration-500">
            
            <div class="flex justify-center mb-8">
                <div class="bg-emerald-600/20 border border-emerald-500 text-emerald-300 px-8 py-4 rounded-2xl text-center shadow-lg backdrop-blur-md">
                    <p class="text-sm uppercase font-bold tracking-widest mb-1">Total de OcorrÃªncias</p>
                    <p class="text-5xl font-black text-white" id="totalDisplay">0</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="glass-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 border-l-4 border-bombeiros-orange pl-3 uppercase">Por Subunidade</h3>
                    <div class="relative h-[550px]"><canvas id="chartPelotoes"></canvas></div>
                </div>
                <div class="glass-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 border-l-4 border-fire-red pl-3 uppercase">Por Natureza</h3>
                    <div class="relative h-[550px]"><canvas id="chartNatureza"></canvas></div>
                </div>
            </div>

            <div class="glass-card p-6 mb-8">
                <h3 class="text-lg font-bold text-white mb-4 border-l-4 border-blue-500 pl-3 uppercase">Detalhamento dos Subgrupos (> 1 OcorrÃªncia)</h3>
                <div id="subgrupoContainer" class="relative" style="height: 600px;"><canvas id="chartSubgrupos"></canvas></div>
            </div>

            <div class="glass-card p-1 overflow-hidden">
                <div class="p-4 border-b border-white/10 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-white border-l-4 border-blue-500 pl-3 uppercase">Detalhamento Completo</h3>
                    <span class="text-xs text-gray-400">Total listado: <span id="totalLista">0</span></span>
                </div>
                <div class="table-scroll">
                    <table class="w-full text-left border-collapse">
                        <thead class="text-xs text-gray-300 uppercase font-bold">
                            <tr>
                                <th class="p-3 text-center w-12">#</th>
                                <th class="p-3">Data</th>
                                <th class="p-3">Natureza</th>
                                <th class="p-3">Subgrupo</th>
                                <th class="p-3">Bairro</th>
                                <th class="p-3">PelotÃ£o</th>
                                <th class="p-3 text-center">Local</th>
                                <th class="p-3 text-right">ID</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaBody" class="text-sm text-gray-200 font-mono"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- 1. CONFIGURAÃ‡Ã•ES E DADOS GLOBAIS ---
        const GITHUB_BASE_URL = 'https://raw.githubusercontent.com/ciabm-1bbm/site/main'; 
        const ANO_ATUAL = 2025;
        
        // Cores padrÃ£o para PelotÃµes
        const colorsPalette = [
            '#EF4444', '#F97316', '#F59E0B', '#10B981', '#06B6D4', '#3B82F6', 
            '#6366F1', '#8B5CF6', '#EC4899', '#F43F5E', '#64748B', '#A8A29E'
        ];

        // --- ESTILOS VISUAIS DAS NATUREZAS ---
        const naturezasStyle = {
            "INCÃŠNDIO": { color: "#FFD700", icon: "ðŸ”¥", cssClass: "text-fire-yellow", cssIcon: "fa-fire" },
            "MANEJO DE INSETOS": { color: "#FEF08A", icon: "ðŸ", cssClass: "text-yellow-200", cssIcon: "fa-bug" },
            "BUSCA E RESGATE": { color: "#F97316", icon: "ðŸ›Ÿ", cssClass: "text-orange-500", cssIcon: "fa-life-ring" },
            "CORTE DE ÃRVORE": { color: "#4ADE80", icon: "ðŸŒ³", cssClass: "text-green-400", cssIcon: "fa-tree" },
            "AÃ‡Ã•ES PREVENTIVAS": { color: "#9CA3AF", icon: "ðŸ›¡ï¸", cssClass: "text-gray-400", cssIcon: "fa-shield-alt" },
            "PRÃ‰-HOSPITALAR": { color: "#EF4444", icon: "ðŸš‘", cssClass: "text-red-500", cssIcon: "fa-ambulance" },
            "PRODUTOS PERIGOSOS": { color: "#FFFFFF", icon: "â˜¢ï¸", cssClass: "text-white", cssIcon: "fa-skull-crossbones" },
            "OUTROS": { color: "#64748B", icon: "âš ï¸", cssClass: "text-bombeiros-orange", cssIcon: "fa-exclamation-triangle" }
        };

        const meses = [
            { id: 'JAN', nome: 'Janeiro' }, { id: 'FEV', nome: 'Fevereiro' },
            { id: 'MAR', nome: 'MarÃ§o' }, { id: 'ABR', nome: 'Abril' },
            { id: 'MAI', nome: 'Maio' }, { id: 'JUN', nome: 'Junho' },
            { id: 'JUL', nome: 'Julho' }, { id: 'AGO', nome: 'Agosto' },
            { id: 'SET', nome: 'Setembro' }, { id: 'OUT', nome: 'Outubro' },
            { id: 'NOV', nome: 'Novembro' }, { id: 'DEZ', nome: 'Dezembro' }
        ];

        let chartP = null;
        let chartN = null;
        let chartS = null;

        document.addEventListener('DOMContentLoaded', () => {
            gerarBotoes();
        });

        function gerarBotoes() {
            const container = document.getElementById('mesesContainer');
            if (!container) return;
            container.innerHTML = '';

            meses.forEach(m => {
                const btn = document.createElement('button');
                btn.className = 'btn-mes bg-slate-800 text-gray-300 py-3 px-1 rounded-lg text-xs font-bold uppercase tracking-wider border border-white/10 hover:bg-white/10 hover:border-emerald-500 transition-all duration-200';
                btn.innerText = m.id;
                btn.onclick = () => carregarDados(m.id, btn);
                container.appendChild(btn);
            });
        }

        async function carregarDados(mes, btnElement) {
            document.querySelectorAll('.btn-mes').forEach(b => {
                b.classList.remove('active');
                b.style.background = '';
                b.style.color = '';
                b.style.borderColor = '';
            });
            if(btnElement) btnElement.classList.add('active');
            
            const msg = document.getElementById('statusMsg');
            msg.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Buscando dados de ${mes}/${ANO_ATUAL}...`;
            msg.className = "mt-2 text-sm text-yellow-400";

            const url = `${GITHUB_BASE_URL}/dados/${mes}_${ANO_ATUAL}.csv`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Arquivo nÃ£o encontrado (${response.status})`);
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    encoding: "UTF-8",
                    complete: function(results) {
                        if (results.data && results.data.length > 0) {
                            try {
                                processarDados(results.data);
                                msg.innerHTML = `<i class="fas fa-check"></i> Dados de ${mes} carregados com sucesso.`;
                                msg.className = "mt-2 text-sm text-green-400";
                                document.getElementById('dashboardArea').classList.remove('opacity-50', 'pointer-events-none');
                            } catch (e) {
                                console.error(e);
                                alert("Erro: " + e.message);
                            }
                        } else {
                            alert("Arquivo vazio.");
                        }
                    }
                });

            } catch (error) {
                console.error(error);
                msg.innerHTML = `<i class="fas fa-times-circle"></i> Erro: Arquivo ${mes}_${ANO_ATUAL}.csv nÃ£o encontrado.`;
                msg.className = "mt-2 text-sm text-red-400";
                document.getElementById('dashboardArea').classList.add('opacity-50', 'pointer-events-none');
            }
        }

        function processarDados(data) {
            const chaves = Object.keys(data[0]);
            
            const colNat = chaves.find(k => k.match(/Emerg/i) || k.match(/Natureza/i));
            const colObm = chaves.find(k => k.match(/Obm/i) || k.match(/Guarni/i));
            const colSub = chaves.find(k => k.match(/subgrupo/i) || k.match(/detalhe/i) || k.match(/tipo/i));

            if (!colNat || !colObm) {
                throw new Error("Colunas obrigatÃ³rias nÃ£o encontradas.");
            }

            const countPelotao = {};
            const countNatureza = {};
            const countSubgrupo = {}; 
            const subgrupoNaturezaMap = {}; 
            const lista = [];
            let total = 0;

            const mapearPelotao = (obmRaw) => {
                const s = obmRaw ? String(obmRaw).toUpperCase() : "";
                if(s.includes("AÃ‡ORIANOS") || s.includes("ACORIANOS")) return "AÃ‡ORIANOS";
                if(s.includes("FLORESTA")) return "FLORESTA";
                if(s.includes("PASSO")) return "PASSO D'AREIA";
                if(s.includes("RESTINGA")) return "RESTINGA";
                if(s.includes("TERESÃ“POLIS") || s.includes("TERESOPOLIS")) return "TERESÃ“POLIS";
                if(s.includes("PARTENON")) return "PARTENON";
                if(s.includes("BELÃ‰M") || s.includes("BELEM")) return "BELÃ‰M NOVO";
                if(s.includes("ASSUNÃ‡ÃƒO") || s.includes("ASSUNCAO")) return "ASSUNÃ‡ÃƒO";
                if(s.includes("RESGATE") || s.includes("GBS")) return "AUTO RESGATE";
                return "OUTROS";
            };

            const mapearNatureza = (natRaw) => {
                let n = natRaw ? String(natRaw).toUpperCase() : "OUTROS";
                if(n.includes("INSETO")) return "MANEJO DE INSETOS";
                if(n.includes("INCÃŠNDIO") || n.includes("INCENDIO")) return "INCÃŠNDIO";
                if(n.includes("SALVAMENTO") || n.includes("BUSCA")) return "BUSCA E RESGATE";
                if(n.includes("ÃRVORE") || n.includes("ARVORE")) return "CORTE DE ÃRVORE";
                if(n.includes("PREVENTIVA")) return "AÃ‡Ã•ES PREVENTIVAS";
                if(n.includes("APH") || n.includes("HOSPITALAR")) return "PRÃ‰-HOSPITALAR";
                if(n.includes("PERIGOSO") || n.includes("HAZMAT")) return "PRODUTOS PERIGOSOS";
                return "OUTROS";
            };

            data.forEach(row => {
                total++;
                const obmValor = row[colObm];
                const natValor = row[colNat];
                let subValor = colSub ? (row[colSub] || "N/A") : "N/A";
                
                const pel = mapearPelotao(obmValor);
                const nat = mapearNatureza(natValor);
                
                countPelotao[pel] = (countPelotao[pel] || 0) + 1;
                countNatureza[nat] = (countNatureza[nat] || 0) + 1;

                if (subValor && subValor !== "N/A" && subValor.trim() !== "") {
                    let subText = subValor.trim();
                    let subKey = `${nat}___${subText}`; 
                    countSubgrupo[subKey] = (countSubgrupo[subKey] || 0) + 1;
                    subgrupoNaturezaMap[subKey] = nat;
                }

                lista.push({
                    id: row['NÂº Oc.'] || row['ID'] || total,
                    data: row['Data'] || row['DATA'] || '---',
                    nat: nat,
                    sub: subValor,
                    bairro: row['Bairro'] || row['BAIRRO'] || '---',
                    vtr: pel,
                    lat: row['Latitude'] || row['LATITUDE'],
                    lon: row['Longitude'] || row['LONGITUDE']
                });
            });

            // PreparaÃ§Ã£o dos GrÃ¡ficos
            const sortedPelotao = Object.entries(countPelotao).sort((a,b) => b[1] - a[1]);
            
            const sortedNatureza = Object.entries(countNatureza).sort((a,b) => b[1] - a[1]);
            const natLabels = sortedNatureza.map(x => {
                const style = naturezasStyle[x[0]] || naturezasStyle["OUTROS"];
                return `${style.icon} ${x[0]}`;
            });
            const natColors = sortedNatureza.map(x => {
                const style = naturezasStyle[x[0]] || naturezasStyle["OUTROS"];
                return style.color;
            });

            // --- FILTRO DE SUBGRUPOS (ACIMA DE 1 OCORRÃŠNCIA) ---
            const sortedSubgrupo = Object.entries(countSubgrupo)
                .filter(([key, count]) => count > 1) // Apenas > 1
                .sort((a,b) => b[1] - a[1]);

            const subLabels = sortedSubgrupo.map(item => {
                const parts = item[0].split('___');
                const natPai = parts[0];
                const subNome = parts[1];
                const style = naturezasStyle[natPai] || naturezasStyle["OUTROS"];
                return `${style.icon} ${natPai} [${subNome}]`;
            });

            const subColors = sortedSubgrupo.map(item => {
                const natPai = item[0].split('___')[0];
                const style = naturezasStyle[natPai] || naturezasStyle["OUTROS"];
                return style.color;
            });

            atualizarDashboard({
                total: total,
                pelotoes: { labels: sortedPelotao.map(x=>x[0]), data: sortedPelotao.map(x=>x[1]) },
                natureza: { 
                    labels: natLabels, 
                    data: sortedNatureza.map(x=>x[1]), 
                    colors: natColors
                },
                subgrupos: { 
                    labels: subLabels, 
                    data: sortedSubgrupo.map(x=>x[1]),
                    colors: subColors
                },
                lista: lista
            });
        }

        function atualizarDashboard(dados) {
            document.getElementById('totalDisplay').innerText = dados.total;
            document.getElementById('totalLista').innerText = dados.total;

            Chart.defaults.color = '#e2e8f0';
            Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';
            Chart.defaults.font.family = 'Inter';

            // ConfiguraÃ§Ã£o Base
            const baseOptions = {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { 
                    x: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                    y: { ticks: { font: { size: 11, weight: '600' }, autoSkip: false } } 
                }
            };

            // 1. GrÃ¡fico PelotÃµes
            if(chartP) chartP.destroy();
            chartP = new Chart(document.getElementById('chartPelotoes'), {
                type: 'bar',
                data: {
                    labels: dados.pelotoes.labels,
                    datasets: [{
                        data: dados.pelotoes.data,
                        backgroundColor: colorsPalette,
                        borderRadius: 4,
                        barPercentage: 0.8
                    }]
                },
                options: baseOptions
            });

            // 2. GrÃ¡fico Natureza
            if(chartN) chartN.destroy();
            chartN = new Chart(document.getElementById('chartNatureza'), {
                type: 'bar',
                data: {
                    labels: dados.natureza.labels,
                    datasets: [{
                        data: dados.natureza.data,
                        backgroundColor: dados.natureza.colors,
                        borderRadius: 4,
                        barPercentage: 0.8
                    }]
                },
                options: {
                    ...baseOptions,
                    scales: {
                        ...baseOptions.scales,
                        y: {
                            ticks: {
                                font: { size: 12, weight: 'bold' },
                                autoSkip: false,
                                color: dados.natureza.colors 
                            }
                        }
                    }
                }
            });

            // 3. GrÃ¡fico Subgrupos (Altura DinÃ¢mica)
            
            // Ajuste dinÃ¢mico da altura do container antes de renderizar
            const subContainer = document.getElementById('subgrupoContainer');
            if(subContainer && dados.subgrupos.labels.length > 0) {
                 // 35px por barra, mÃ­nimo 600px
                 const dynamicHeight = Math.max(600, dados.subgrupos.labels.length * 35);
                 subContainer.style.height = dynamicHeight + 'px';
            }

            if(chartS) chartS.destroy();
            chartS = new Chart(document.getElementById('chartSubgrupos'), {
                type: 'bar',
                data: {
                    labels: dados.subgrupos.labels,
                    datasets: [{
                        data: dados.subgrupos.data,
                        backgroundColor: dados.subgrupos.colors,
                        borderRadius: 4,
                        barPercentage: 0.8
                    }]
                },
                options: {
                    ...baseOptions,
                    scales: {
                        ...baseOptions.scales,
                        y: {
                            ticks: {
                                font: { size: 11, weight: 'bold' },
                                autoSkip: false,
                                color: dados.subgrupos.colors 
                            }
                        }
                    }
                }
            });

            renderTable(dados.lista);
        }

        function renderTable(lista) {
            const tbody = document.getElementById('tabelaBody');
            tbody.innerHTML = '';

            lista.forEach((oc, index) => {
                const style = naturezasStyle[oc.nat] || naturezasStyle["OUTROS"];
                
                let mapsLink = '';
                if(oc.lat && oc.lon) {
                    const lat = String(oc.lat).replace(',', '.');
                    const lon = String(oc.lon).replace(',', '.');
                    const urlMap = `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;
                    mapsLink = `<a href="${urlMap}" target="_blank" class="text-blue-400 hover:text-white transition-colors"><i class="fas fa-map-marker-alt fa-lg"></i></a>`;
                } else {
                    mapsLink = `<span class="text-gray-600 cursor-not-allowed"><i class="fas fa-map-marker-slash"></i></span>`;
                }

                const tr = `
                    <tr class="hover:bg-white/5 transition-colors border-b border-white/5 odd:bg-white/5 even:bg-transparent">
                        <td class="p-3 text-center font-bold text-gray-500 text-xs">${index + 1}</td>
                        <td class="p-3 font-mono opacity-80 whitespace-nowrap text-xs">${oc.data}</td>
                        <td class="p-3 font-bold ${style.cssClass} text-xs">
                            <i class="fas ${style.cssIcon} w-4 text-center mr-1"></i> ${oc.nat}
                        </td>
                        <td class="p-3 text-xs text-blue-200">${oc.sub || '-'}</td>
                        <td class="p-3 uppercase text-xs tracking-wider text-gray-300">${oc.bairro}</td>
                        <td class="p-3"><span class="bg-slate-700 text-white px-2 py-1 rounded text-xs font-mono border border-white/10 whitespace-nowrap">${oc.vtr}</span></td>
                        <td class="p-3 text-center">${mapsLink}</td>
                        <td class="p-3 text-right font-mono opacity-50 text-xs">#${oc.id}</td>
                    </tr>
                `;
                tbody.innerHTML += tr;
            });
        }
    </script>
</body>
</html>

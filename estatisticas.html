<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estatísticas 1º BBM - Porto Alegre</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'fire-red': '#DC2626',
                        'fire-yellow': '#FFD700',
                        'bombeiros-orange': '#F97316',
                        'dark-bg': '#0f172a',
                        'cb-green': '#10B981'
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body { background-color: #0f172a; color: white; font-family: 'Inter', sans-serif; }
        
        .hero-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .hero-bg::before {
            content: ''; position: absolute; top: 20%; left: 10%; right: 10%; bottom: 0;
            background: url('https://github.com/ciabm-1bbm/site/blob/main/images/brasao_1BBM_PARA_site.png?raw=true') no-repeat center top;
            background-size: contain; opacity: 0.1; filter: grayscale(100%);
        }
        .hero-bg::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle, rgba(15,23,42,0.4) 0%, rgba(15,23,42,0.9) 100%);
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        /* Botões de Mês - VERDE quando ativo */
        .btn-mes {
            transition: all 0.2s;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .btn-mes:hover { background: rgba(255,255,255,0.1); border-color: #10B981; }
        
        .btn-mes.active { 
            background: linear-gradient(45deg, #10B981, #059669);
            color: white; 
            border-color: #A7F3D0;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.4);
            transform: scale(1.05);
        }

        /* Scrollbar Tabela */
        .table-scroll { max-height: 500px; overflow-y: auto; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        thead th { position: sticky; top: 0; z-index: 10; background-color: rgba(15, 23, 42, 0.95); }
    </style>
</head>
<body class="min-h-screen">

    <div class="hero-bg"></div>

    <div class="container mx-auto px-4 py-8 relative z-10">
        
        <header class="flex flex-col md:flex-row items-center justify-between mb-8 gap-6 glass-card p-6">
            <img src="https://www.bombeiros.rs.gov.br/themes/sitecbmrs/images/logos/logo.png" class="h-20 drop-shadow-lg opacity-90">
            
            <div class="text-center flex-1">
                <h1 class="text-3xl font-black uppercase tracking-tighter text-white mb-2 leading-none">
                    Estatísticas de Ocorrências
                </h1>
                <h2 class="text-xl font-bold text-fire-yellow tracking-widest uppercase">
                    1º BBM - PORTO ALEGRE (<span id="anoTitulo">2025</span>)
                </h2>
                <div class="mt-2 text-sm text-gray-400" id="statusMsg">Selecione um mês para carregar os dados</div>
            </div>

            <img src="https://github.com/ciabm-1bbm/site/blob/main/images/brasao_1BBM_PARA_site.png?raw=true" class="h-20 drop-shadow-lg opacity-90">
        </header>

        <div class="glass-card p-4 mb-8">
            <div class="grid grid-cols-3 md:grid-cols-6 lg:grid-cols-12 gap-2" id="mesesContainer"></div>
        </div>

        <div id="dashboardArea" class="opacity-50 pointer-events-none transition-opacity duration-500">
            
            <div class="flex justify-center mb-8">
                <div class="bg-emerald-600/20 border border-emerald-500 text-emerald-300 px-8 py-4 rounded-2xl text-center shadow-lg backdrop-blur-md">
                    <p class="text-sm uppercase font-bold tracking-widest mb-1">Total de Ocorrências</p>
                    <p class="text-5xl font-black text-white" id="totalDisplay">0</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="glass-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 border-l-4 border-bombeiros-orange pl-3 uppercase">Por Subunidade</h3>
                    <div class="relative h-[500px]"><canvas id="chartPelotoes"></canvas></div>
                </div>
                <div class="glass-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4 border-l-4 border-fire-red pl-3 uppercase">Por Natureza</h3>
                    <div class="relative h-[500px]"><canvas id="chartNatureza"></canvas></div>
                </div>
            </div>

            <div class="glass-card p-6 mb-8">
                <h3 class="text-lg font-bold text-white mb-4 border-l-4 border-blue-500 pl-3 uppercase">Principais Subgrupos (Top 20)</h3>
                <div class="relative h-[600px]"><canvas id="chartSubgrupos"></canvas></div>
            </div>

            <div class="glass-card p-1 overflow-hidden">
                <div class="p-4 border-b border-white/10 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-white border-l-4 border-blue-500 pl-3 uppercase">Detalhamento</h3>
                    <span class="text-xs text-gray-400">Total listado: <span id="totalLista">0</span></span>
                </div>
                <div class="table-scroll">
                    <table class="w-full text-left border-collapse">
                        <thead class="text-xs text-gray-300 uppercase font-bold">
                            <tr>
                                <th class="p-3 text-center w-12">#</th>
                                <th class="p-3">Data</th>
                                <th class="p-3">Natureza</th>
                                <th class="p-3">Subgrupo</th>
                                <th class="p-3">Bairro</th>
                                <th class="p-3">Pelotão</th> <th class="p-3 text-center">Local</th>
                                <th class="p-3 text-right">ID</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaBody" class="text-sm text-gray-200 font-mono"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- 1. CONFIGURAÇÕES E DADOS GLOBAIS ---
        const GITHUB_BASE_URL = 'https://raw.githubusercontent.com/ciabm-1bbm/site/main'; 
        const ANO_ATUAL = 2025;
        
        // Paleta base para naturezas
        const colorsPalette = [
            '#EF4444', '#F97316', '#F59E0B', '#10B981', '#06B6D4', '#3B82F6', 
            '#6366F1', '#8B5CF6', '#EC4899', '#F43F5E', '#64748B', '#A8A29E'
        ];

        // Mapeamento de Cores por Natureza (Para o gráfico de Subgrupos)
        const naturezaColors = {
            "INCÊNDIO": "#EF4444", // Vermelho
            "MANEJO DE INSETOS": "#F59E0B", // Amarelo/Laranja
            "BUSCA E RESGATE": "#10B981", // Verde
            "CORTE DE ÁRVORE": "#22C55E", // Verde Claro
            "AÇÕES PREVENTIVAS": "#94A3B8", // Cinza
            "PRÉ-HOSPITALAR": "#F43F5E", // Rosa/Vermelho
            "OUTROS": "#64748B" // Padrão
        };

        const meses = [
            { id: 'JAN', nome: 'Janeiro' }, { id: 'FEV', nome: 'Fevereiro' },
            { id: 'MAR', nome: 'Março' }, { id: 'ABR', nome: 'Abril' },
            { id: 'MAI', nome: 'Maio' }, { id: 'JUN', nome: 'Junho' },
            { id: 'JUL', nome: 'Julho' }, { id: 'AGO', nome: 'Agosto' },
            { id: 'SET', nome: 'Setembro' }, { id: 'OUT', nome: 'Outubro' },
            { id: 'NOV', nome: 'Novembro' }, { id: 'DEZ', nome: 'Dezembro' }
        ];

        let chartP = null;
        let chartN = null;
        let chartS = null;

        document.addEventListener('DOMContentLoaded', () => {
            gerarBotoes();
        });

        function gerarBotoes() {
            const container = document.getElementById('mesesContainer');
            if (!container) return;
            container.innerHTML = '';

            meses.forEach(m => {
                const btn = document.createElement('button');
                btn.className = 'btn-mes bg-slate-800 text-gray-300 py-3 px-1 rounded-lg text-xs font-bold uppercase tracking-wider border border-white/10 hover:bg-white/10 hover:border-emerald-500 transition-all duration-200';
                btn.innerText = m.id;
                btn.onclick = () => carregarDados(m.id, btn);
                container.appendChild(btn);
            });
        }

        async function carregarDados(mes, btnElement) {
            document.querySelectorAll('.btn-mes').forEach(b => {
                b.classList.remove('active');
                b.style.background = '';
                b.style.color = '';
                b.style.borderColor = '';
            });
            if(btnElement) btnElement.classList.add('active');
            
            const msg = document.getElementById('statusMsg');
            msg.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Buscando dados de ${mes}/${ANO_ATUAL}...`;
            msg.className = "mt-2 text-sm text-yellow-400";

            const url = `${GITHUB_BASE_URL}/dados/${mes}_${ANO_ATUAL}.csv`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Arquivo não encontrado (${response.status})`);
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    encoding: "UTF-8",
                    complete: function(results) {
                        if (results.data && results.data.length > 0) {
                            try {
                                processarDados(results.data);
                                msg.innerHTML = `<i class="fas fa-check"></i> Dados de ${mes} carregados com sucesso.`;
                                msg.className = "mt-2 text-sm text-green-400";
                                document.getElementById('dashboardArea').classList.remove('opacity-50', 'pointer-events-none');
                            } catch (e) {
                                console.error(e);
                                alert("Erro: " + e.message);
                            }
                        } else {
                            alert("Arquivo vazio.");
                        }
                    }
                });

            } catch (error) {
                console.error(error);
                msg.innerHTML = `<i class="fas fa-times-circle"></i> Erro: Arquivo ${mes}_${ANO_ATUAL}.csv não encontrado.`;
                msg.className = "mt-2 text-sm text-red-400";
                document.getElementById('dashboardArea').classList.add('opacity-50', 'pointer-events-none');
            }
        }

        function processarDados(data) {
            const chaves = Object.keys(data[0]);
            
            const colNat = chaves.find(k => k.match(/Emerg/i) || k.match(/Natureza/i));
            const colObm = chaves.find(k => k.match(/Obm/i) || k.match(/Guarni/i));
            const colSub = chaves.find(k => k.match(/subgrupo/i) || k.match(/detalhe/i) || k.match(/tipo/i));

            if (!colNat || !colObm) {
                throw new Error("Colunas obrigatórias não encontradas.");
            }

            const countPelotao = {};
            const countNatureza = {};
            const countSubgrupo = {}; 
            // Armazena a natureza do subgrupo para pegar a cor depois
            const subgrupoNaturezaMap = {}; 
            const lista = [];
            let total = 0;

            const mapearPelotao = (obmRaw) => {
                const s = obmRaw ? String(obmRaw).toUpperCase() : "";
                if(s.includes("AÇORIANOS") || s.includes("ACORIANOS")) return "AÇORIANOS";
                if(s.includes("FLORESTA")) return "FLORESTA";
                if(s.includes("PASSO")) return "PASSO D'AREIA";
                if(s.includes("RESTINGA")) return "RESTINGA";
                if(s.includes("TERESÓPOLIS") || s.includes("TERESOPOLIS")) return "TERESÓPOLIS";
                if(s.includes("PARTENON")) return "PARTENON";
                if(s.includes("BELÉM") || s.includes("BELEM")) return "BELÉM NOVO";
                if(s.includes("ASSUNÇÃO") || s.includes("ASSUNCAO")) return "ASSUNÇÃO";
                if(s.includes("RESGATE") || s.includes("GBS")) return "AUTO RESGATE";
                return "OUTROS";
            };

            const mapearNatureza = (natRaw) => {
                let n = natRaw ? String(natRaw).toUpperCase() : "OUTROS";
                if(n.includes("INSETO")) return "MANEJO DE INSETOS";
                if(n.includes("INCÊNDIO") || n.includes("INCENDIO")) return "INCÊNDIO";
                if(n.includes("SALVAMENTO") || n.includes("BUSCA")) return "BUSCA E RESGATE";
                if(n.includes("ÁRVORE") || n.includes("ARVORE")) return "CORTE DE ÁRVORE";
                if(n.includes("PREVENTIVA")) return "AÇÕES PREVENTIVAS";
                if(n.includes("APH") || n.includes("HOSPITALAR")) return "PRÉ-HOSPITALAR";
                return "OUTROS";
            };

            data.forEach(row => {
                total++;
                
                const obmValor = row[colObm];
                const natValor = row[colNat];
                let subValor = colSub ? (row[colSub] || "N/A") : "N/A";
                
                // Normalizações
                const pel = mapearPelotao(obmValor);
                const nat = mapearNatureza(natValor);
                
                countPelotao[pel] = (countPelotao[pel] || 0) + 1;
                countNatureza[nat] = (countNatureza[nat] || 0) + 1;

                if (subValor && subValor !== "N/A" && subValor.trim() !== "") {
                    // Limpa e formata: INCÊNDIO [Lixo]
                    let subText = subValor.trim();
                    let subFull = `${nat} [${subText}]`;
                    
                    countSubgrupo[subFull] = (countSubgrupo[subFull] || 0) + 1;
                    subgrupoNaturezaMap[subFull] = nat; // Salva o pai para colorir depois
                }

                lista.push({
                    id: row['Nº Oc.'] || row['ID'] || total,
                    data: row['Data'] || row['DATA'] || '---',
                    nat: nat,
                    sub: subValor,
                    bairro: row['Bairro'] || row['BAIRRO'] || '---',
                    vtr: pel,
                    lat: row['Latitude'] || row['LATITUDE'],
                    lon: row['Longitude'] || row['LONGITUDE']
                });
            });

            // Preparação dos Gráficos
            const sortedPelotao = Object.entries(countPelotao).sort((a,b) => b[1] - a[1]);
            const sortedNatureza = Object.entries(countNatureza).sort((a,b) => b[1] - a[1]);
            
            // Subgrupos (Top 20)
            const sortedSubgrupo = Object.entries(countSubgrupo)
                .sort((a,b) => b[1] - a[1])
                .slice(0, 20);

            // Gerar array de cores para os subgrupos baseado na natureza pai
            const subgrupoColors = sortedSubgrupo.map(item => {
                const nomeCompleto = item[0];
                const naturezaPai = subgrupoNaturezaMap[nomeCompleto];
                return naturezaColors[naturezaPai] || "#64748B"; // Cor específica ou cinza padrão
            });

            atualizarDashboard({
                total: total,
                pelotoes: { labels: sortedPelotao.map(x=>x[0]), data: sortedPelotao.map(x=>x[1]) },
                natureza: { labels: sortedNatureza.map(x=>x[0]), data: sortedNatureza.map(x=>x[1]) },
                subgrupos: { 
                    labels: sortedSubgrupo.map(x=>x[0]), 
                    data: sortedSubgrupo.map(x=>x[1]),
                    colors: subgrupoColors // Array de cores correto
                },
                lista: lista
            });
        }

        function atualizarDashboard(dados) {
            document.getElementById('totalDisplay').innerText = dados.total;
            document.getElementById('totalLista').innerText = dados.total;

            Chart.defaults.color = '#e2e8f0';
            Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';
            Chart.defaults.font.family = 'Inter';

            const commonOptions = {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        titleFont: { size: 14, weight: 'bold' },
                        bodyFont: { size: 13 },
                        padding: 10,
                        backgroundColor: 'rgba(15, 23, 42, 0.95)',
                        borderColor: 'rgba(255,255,255,0.1)',
                        borderWidth: 1
                    }
                },
                scales: { 
                    x: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                    y: { ticks: { font: { size: 11, weight: '600' }, color: '#cbd5e1', autoSkip: false } } 
                }
            };

            // Gráfico Pelotão
            if(chartP) chartP.destroy();
            chartP = new Chart(document.getElementById('chartPelotoes'), {
                type: 'bar',
                data: {
                    labels: dados.pelotoes.labels,
                    datasets: [{
                        data: dados.pelotoes.data,
                        backgroundColor: colorsPalette,
                        borderRadius: 4,
                        barPercentage: 0.8
                    }]
                },
                options: commonOptions
            });

            // Gráfico Natureza
            if(chartN) chartN.destroy();
            chartN = new Chart(document.getElementById('chartNatureza'), {
                type: 'bar',
                data: {
                    labels: dados.natureza.labels,
                    datasets: [{
                        data: dados.natureza.data,
                        backgroundColor: colorsPalette,
                        borderRadius: 4,
                        barPercentage: 0.8
                    }]
                },
                options: commonOptions
            });

            // Gráfico Subgrupos (COM CORES MAPEADAS)
            if(chartS) chartS.destroy();
            chartS = new Chart(document.getElementById('chartSubgrupos'), {
                type: 'bar',
                data: {
                    labels: dados.subgrupos.labels,
                    datasets: [{
                        data: dados.subgrupos.data,
                        backgroundColor: dados.subgrupos.colors, // Aplica cores dinâmicas
                        borderRadius: 4,
                        barPercentage: 0.8
                    }]
                },
                options: commonOptions
            });

            renderTable(dados.lista);
        }

        function renderTable(lista) {
            const tbody = document.getElementById('tabelaBody');
            tbody.innerHTML = '';

            lista.forEach((oc, index) => {
                let cor = 'text-white';
                let icon = 'fa-bell';
                let tipo = oc.nat; // Já vem normalizado

                if(tipo.includes('INCÊNDIO')) { cor = 'text-fire-yellow'; icon = 'fa-fire'; }
                else if(tipo.includes('PREVENTIVA')) { cor = 'text-gray-400'; icon = 'fa-shield-alt'; }
                else if(tipo.includes('ÁRVORE')) { cor = 'text-green-400'; icon = 'fa-tree'; }
                else if(tipo.includes('INSETO')) { cor = 'text-yellow-200'; icon = 'fa-bug'; }
                else if(tipo.includes('HOSPITALAR')) { cor = 'text-red-500'; icon = 'fa-ambulance'; }
                else { cor = 'text-bombeiros-orange'; icon = 'fa-exclamation-triangle'; }

                let mapsLink = '';
                if(oc.lat && oc.lon) {
                    const lat = String(oc.lat).replace(',', '.');
                    const lon = String(oc.lon).replace(',', '.');
                    const urlMap = `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;
                    mapsLink = `<a href="${urlMap}" target="_blank" class="text-blue-400 hover:text-white transition-colors"><i class="fas fa-map-marker-alt fa-lg"></i></a>`;
                } else {
                    mapsLink = `<span class="text-gray-600 cursor-not-allowed"><i class="fas fa-map-marker-slash"></i></span>`;
                }

                // Linha da Tabela
                const tr = `
                    <tr class="hover:bg-white/5 transition-colors border-b border-white/5 odd:bg-white/5 even:bg-transparent">
                        <td class="p-3 text-center font-bold text-gray-500 text-xs">${index + 1}</td>
                        <td class="p-3 font-mono opacity-80 whitespace-nowrap text-xs">${oc.data}</td>
                        <td class="p-3 font-bold ${cor} text-xs"><i class="fas ${icon} w-4 text-center"></i> ${oc.nat}</td>
                        <td class="p-3 text-xs text-blue-200">${oc.sub || '-'}</td>
                        <td class="p-3 uppercase text-xs tracking-wider text-gray-300">${oc.bairro}</td>
                        <td class="p-3"><span class="bg-slate-700 text-white px-2 py-1 rounded text-xs font-mono border border-white/10 whitespace-nowrap">${oc.vtr}</span></td>
                        <td class="p-3 text-center">${mapsLink}</td>
                        <td class="p-3 text-right font-mono opacity-50 text-xs">#${oc.id}</td>
                    </tr>
                `;
                tbody.innerHTML += tr;
            });
        }
    </script>
</body>
</html>
